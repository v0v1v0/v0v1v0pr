<div class="container">

<table style="width: 100%;"><tr>
<td>fit_bd_backbone_c</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Maximum likelihood fit of the general birth-death model (backbone and constraints)
</h2>

<h3>Description</h3>

<p>Fits the birth-death model with potentially time-varying rates and potentially missing extant species to a phylogeny, by maximum likelihood. Notations follow Morlon et al. PNAS 2011. Modified version of fit_bd for backbones and to add constraints on rate estimtes.
</p>


<h3>Usage</h3>

<pre><code class="language-R">  fit_bd_backbone_c(phylo, tot_time, f.lamb, f.mu, lamb_par, mu_par, f = 1,
                    backbone, spec_times, branch_times,
                    meth = "Nelder-Mead", cst.lamb = FALSE, cst.mu = FALSE,
                    expo.lamb = FALSE, expo.mu = FALSE, fix.mu = FALSE,
                    dt=1e-3, cond = "crown", model, rate.max, n.max)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>phylo</code></td>
<td>

<p>an object of type 'phylo' (see ape documentation)
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tot_time</code></td>
<td>

<p>the age of the phylogeny (crown age, or stem age if known). If working with crown ages, tot_time is given by max(node.age(phylo)$ages).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f.lamb</code></td>
<td>

<p>a function specifying the hypothesized functional form (e.g. constant, linear, exponential, etc.) of the variation of the speciation rate <code class="reqn">\lambda</code> with time. Any functional form may be used.
This function has two arguments: the first argument is time; the second argument is a numeric vector of the parameters of the time-variation (to be estimated).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f.mu</code></td>
<td>

<p>a function specifying the hypothesized functional form (e.g. constant, linear, exponential, etc.) of the variation of the extinction rate <code class="reqn">\mu</code> with time. Any functional form may be used.
This function has two arguments: the first argument is time; the second argument is a numeric vector of the parameters of the time-variation (to be estimated).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lamb_par</code></td>
<td>

<p>a numeric vector of initial values for the parameters of f.lamb to be estimated (these values are used by the optimization algorithm). The length of this vector is used to compute the total number of parameters in the model, so to fit a model with constant speciation rate (for example), lamb_par should be a vector of length 1. Otherwise aic values will be wrong.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mu_par</code></td>
<td>

<p>a numeric vector of initial values for the parameters of f.mu to be estimated (these values are used by the optimization algorithm). The length of this vector is used to compute the total number of parameters in the model, so to fit a model without extinction (for example), mu_par should be empty (vector of length 0). Otherwise aic values will be wrong.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f</code></td>
<td>

<p>the fraction of extant species included in the phylogeny
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>backbone</code></td>
<td>

<p>character. Allows to analyse a backbone. Default is FALSE and spec_times and branch_times are then ignored.
Otherwise
</p>
 
<ul>
<li>
<p>"stem.shift": the stems of subclades are included in subclade analyses;
</p>
</li>
<li>
<p>"crown.shift": the stems of subclades are included in the backbone analysis.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>spec_times</code></td>
<td>

<p>a numeric vector of the stem ages of subclades. Used only if backbone = "stem.shift". Default is NULL.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>branch_times</code></td>
<td>

<p>a list of numeric vectors. Each vector contains the stem and crown ages of subclades (in this order). Used only if backbone = "crown.shift". Default is NULL.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>meth</code></td>
<td>

<p>optimization to use to maximize the likelihood function, see <em>optim</em> for more details.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cst.lamb</code></td>
<td>

<p>logical: should be set to TRUE only if f.lamb is constant (i.e. does not depend on time) to use analytical instead of numerical computation in order to reduce computation time.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cst.mu</code></td>
<td>

<p>logical: should be set to TRUE only if f.mu is constant (i.e. does not depend on time) to use analytical instead of numerical computation in order to reduce computation time.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>expo.lamb</code></td>
<td>

<p>logical: should be set to TRUE only if f.lamb is exponential to use analytical instead of numerical computation in order to reduce computation time.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>expo.mu</code></td>
<td>

<p>logical: should be set to TRUE only if f.mu is exponential to use analytical instead of numerical computation in order to reduce computation time.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fix.mu</code></td>
<td>

<p>logical: if set to TRUE, the extinction rate <code class="reqn">\mu</code> is fixed and will not be optimized.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dt</code></td>
<td>

<p>the default value is 0. In this case, integrals in the likelihood are computed using R "integrate" function, which can be quite slow. If a positive dt is given as argument, integrals are computed using a piece-wise contant approximation, and dt represents the length of the intervals on which functions are assumed to be constant. For an exponential dependency of the speciation rate with time, we found that dt=1e-3 gives a good trade-off between precision and computation time.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cond</code></td>
<td>

<p>conditioning to use to fit the model:
</p>
 <ul>
<li>
<p> FALSE: no conditioning (not recommended);
</p>
</li>
<li>
<p> "stem": conditioning on the survival of the stem lineage (use when the stem age is known, in this case tot_time should be the stem age);
</p>
</li>
<li>
<p> "crown" (default): conditioning on a speciation event at the crown age and survival of the 2 daugther lineages (use when the stem age is not known, in this case tot_time should be the crown age).
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>

<p>character. The model name as defined in the function div.models.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rate.max</code></td>
<td>

<p>numeric. Set a limit of diversificaton rates in terme of rate values.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n.max</code></td>
<td>

<p>numeric. Set a limit of diversificaton rates in terms of diversity estimates with the deterministic approach.
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The lengths of lamb_par and mu_par are used to compute the total number of parameters in the model, so to fit a model with constant speciation rate (for example), lamb_par should be a vector of length 1. Otherwise aic values will be wrong. In the f.lamb and f.mu functions, the first argument (time) runs from the present to the past. Hence, if the parameter controlling the variation of <code class="reqn">\lambda</code> with time is estimated to be positive (for example), this means that the speciation rate decreases from past to present. Note that abs(f.lamb) and abs(f.mu) are used in the likelihood computation as speciation and extinction rates should always be positive. A consequence of 
this is that negative speciation/extinction rates estimates can be returned. They should be interpreted in absolute terms. See Morlon et al. 2020 for a more detailed explanation.</p>


<h3>Value</h3>

<p>a list with the following components
</p>
<table>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>the name of the fitted model</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>LH</code></td>
<td>
<p>the maximum log-likelihood value</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>aicc</code></td>
<td>
<p>the second order Akaike's Information Criterion</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lamb_par</code></td>
<td>
<p>a numeric vector of estimated f.lamb parameters, in the same order as defined in f.lamb</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mu_par</code></td>
<td>
<p>a numeric vector of estimated f.mu parameters, in the same order as defined in f.mu (if fix.mu is FALSE)</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Hélène Morlon, Nathan Mazet</p>


<h3>References</h3>

<p>Morlon, H., Parsons, T.L. and Plotkin, J.B. (2011) Reconciling molecular phylogenies with the fossil record <em>Proc Nat Acad Sci</em> 108: 16327-16332
</p>
<p>Morlon, H. (2014) Phylogenetic approaches for studying diversification, Eco Lett 17:508-525
Morlon, H., Rolland, J. and Condamine, F. (2020) Response to Technical Comment ‘A cautionary note for users of linear diversification dependencies’, Eco Lett
Mazet, N., Morlon, H., Fabre, P., Condamine, F.L., (2023). Estimating clade‐specific diversification rates and palaeodiversity dynamics from reconstructed phylogenies. <em>Methods in Ecology and in Evolution</em> 14, 2575–2591. https://doi.org/10.1111/2041-210X.14195
</p>


<h3>See Also</h3>

<p><code>plot_fit_bd</code>, <code>plot_dtt</code>, <code>likelihood_bd, fit_env</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R"># Some examples may take a little bit of time. Be patient!
data(Cetacea)
tot_time&lt;-max(node.age(Cetacea)$ages)
# Fit the pure birth model (no extinction) with a constant speciation rate
f.lamb &lt;-function(t,y){y[1]}
f.mu&lt;-function(t,y){0}
lamb_par&lt;-c(0.09)
mu_par&lt;-c()
#result_cst &lt;- fit_bd(Cetacea,tot_time,f.lamb,f.mu,lamb_par,mu_par,
#                     f=87/89,cst.lamb=TRUE,fix.mu=TRUE,dt=1e-3)
#result_cst$model &lt;- "pure birth with constant speciation rate"
# Fit the pure birth model (no extinction) with exponential variation
# of the speciation rate with time
f.lamb &lt;-function(t,y){y[1] * exp(y[2] * t)}
f.mu&lt;-function(t,y){0}
lamb_par&lt;-c(0.05, 0.01)
mu_par&lt;-c()
#result_exp &lt;- fit_bd(Cetacea,tot_time,f.lamb,f.mu,lamb_par,mu_par,
#                     f=87/89,expo.lamb=TRUE,fix.mu=TRUE,dt=1e-3)
#result_exp$model &lt;- "pure birth with exponential variation in speciation rate"
# Fit the pure birth model (no extinction) with linear variation of
# the speciation rate with time
f.lamb &lt;-function(t,y){abs(y[1] + y[2] * t)}
# alternative formulation that can be used depending on the choice made to avoid negative rates: 
# f.lamb &lt;-function(t,y){pmax(0,y[1] + y[2] * t)}, see Morlon et al. (2020)
f.mu&lt;-function(t,y){0}
lamb_par&lt;-c(0.09, 0.001)
mu_par&lt;-c()
#result_lin &lt;- fit_bd(Cetacea,tot_time,f.lamb,f.mu,lamb_par,mu_par,f=87/89,fix.mu=TRUE,dt=1e-3)
#result_lin$model &lt;- "pure birth with linear variation in speciation rate"
# Fit a birth-death model with exponential variation of the speciation
# rate with time and constant extinction
f.lamb&lt;-function(t,y){y[1] * exp(y[2] * t)}
f.mu &lt;-function(t,y){y[1]}
lamb_par &lt;- c(0.05, 0.01)
mu_par &lt;-c(0.005)
#result_bexp_dcst &lt;- fit_bd(Cetacea,tot_time,f.lamb,f.mu,lamb_par,mu_par,
#                           f=87/89,expo.lamb=TRUE,cst.mu=TRUE,dt=1e-3)
#result_bexp_dcst$model &lt;- "birth-death with exponential variation in speciation rate
#                           and constant extinction"
# Find the best model
#index &lt;- which.min(c(result_cst$aicc, result_exp$aicc, result_lin$aicc,result_bexp_dcst$aicc))
#rbind(result_cst, result_exp, result_lin, result_bexp_dcst)[index,]
</code></pre>


</div>