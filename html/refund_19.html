<div class="container">

<table style="width: 100%;"><tr>
<td>fbps</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Sandwich smoother for matrix data</h2>

<h3>Description</h3>

<p>A fast bivariate <em>P</em>-spline method for smoothing matrix data.
</p>


<h3>Usage</h3>

<pre><code class="language-R">fbps(
  data,
  subj = NULL,
  covariates = NULL,
  knots = 35,
  knots.option = "equally-spaced",
  periodicity = c(FALSE, FALSE),
  p = 3,
  m = 2,
  lambda = NULL,
  selection = "GCV",
  search.grid = T,
  search.length = 100,
  method = "L-BFGS-B",
  lower = -20,
  upper = 20,
  control = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>n1 by n2 data matrix without missing data</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subj</code></td>
<td>
<p>vector of subject id (corresponding to the columns of data); defaults to NULL</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>covariates</code></td>
<td>
<p>list of two vectors of covariates of lengths n1 and n2;
if NULL, then generates equidistant covariates</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>knots</code></td>
<td>
<p>list of two vectors of knots or number of equidistant knots
for all dimensions; defaults to 35</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>knots.option</code></td>
<td>
<p>knot selection method; defaults to "equally-spaced"</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>periodicity</code></td>
<td>
<p>vector of two logical, indicating periodicity in the direction of row and column; defaults to c(FALSE, FALSE)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p</code></td>
<td>
<p>degrees of B-splines; defaults to 3</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>m</code></td>
<td>
<p>order of differencing penalty; defaults to 2</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lambda</code></td>
<td>
<p>user-specified smoothing parameters; defaults to NULL</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>selection</code></td>
<td>
<p>selection of smoothing parameter; defaults to "GCV"</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>search.grid</code></td>
<td>
<p>logical; defaults to TRUE, if FALSE, uses
<code>optim</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>search.length</code></td>
<td>
<p>number of equidistant (log scale) smoothing parameter;
defaults to 100</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>see <code>optim</code>; defaults to <code>L-BFGS-B</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lower, upper</code></td>
<td>
<p>bounds for log smoothing parameter, passed to
<code>optim</code>; defaults are -20 and 20.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control</code></td>
<td>
<p>see <code>optim</code></p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The smoothing parameter can be user-specified; otherwise, the function uses
grid searching method or <code>optim</code> for selecting the smoothing
parameter.
</p>


<h3>Value</h3>

<p>A list with components </p>
<table>
<tr style="vertical-align: top;">
<td><code>lambda</code></td>
<td>
<p>vector of length 2 of selected
smoothing parameters</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Yhat</code></td>
<td>
<p>fitted data</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>trace</code></td>
<td>
<p>trace of the
overall smoothing matrix</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gcv</code></td>
<td>
<p>value of generalized cross validation</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Theta</code></td>
<td>
<p>matrix of estimated coefficients</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Luo Xiao <a href="mailto:lxiao@jhsph.edu">lxiao@jhsph.edu</a>
</p>


<h3>References</h3>

<p>Xiao, L., Li, Y., and Ruppert, D. (2013). Fast bivariate
<em>P</em>-splines: the sandwich smoother. <em>Journal of the Royal
Statistical Society: Series B</em>, 75(3), 577â€“599.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
##########################
#### True function   #####
##########################
n1 &lt;- 60
n2 &lt;- 80
x &lt;- (1:n1)/n1-1/2/n1
z &lt;- (1:n2)/n2-1/2/n2
MY &lt;- array(0,c(length(x),length(z)))

sigx &lt;- .3
sigz &lt;- .4
for(i in 1:length(x))
for(j in 1:length(z))
{
#MY[i,j] &lt;- .75/(pi*sigx*sigz) *exp(-(x[i]-.2)^2/sigx^2-(z[j]-.3)^2/sigz^2)
#MY[i,j] &lt;- MY[i,j] + .45/(pi*sigx*sigz) *exp(-(x[i]-.7)^2/sigx^2-(z[j]-.8)^2/sigz^2)
MY[i,j] = sin(2*pi*(x[i]-.5)^3)*cos(4*pi*z[j])
}
##########################
#### Observed data   #####
##########################
sigma &lt;- 1
Y &lt;- MY + sigma*rnorm(n1*n2,0,1)
##########################
####   Estimation    #####
##########################

est &lt;- fbps(Y,list(x=x,z=z))
mse &lt;- mean((est$Yhat-MY)^2)
cat("mse of fbps is",mse,"\n")
cat("The smoothing parameters are:",est$lambda,"\n")
########################################################################
########## Compare the estimated surface with the true surface #########
########################################################################

par(mfrow=c(1,2))
persp(x,z,MY,zlab="f(x,z)",zlim=c(-1,2.5), phi=30,theta=45,expand=0.8,r=4,
      col="blue",main="True surface")
persp(x,z,est$Yhat,zlab="f(x,z)",zlim=c(-1,2.5),phi=30,theta=45,
      expand=0.8,r=4,col="red",main="Estimated surface")
</code></pre>


</div>