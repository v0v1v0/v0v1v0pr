<div class="container">

<table style="width: 100%;"><tr>
<td>modelTest</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Monte-Carlo simulation test for SPDs</h2>

<h3>Description</h3>

<p>Comparison of an observed summed radiocarbon date distribution (aka SPD) with simulated outcomes from a theoretical model.
</p>


<h3>Usage</h3>

<pre><code class="language-R">modelTest(
  x,
  errors,
  nsim,
  bins = NA,
  runm = NA,
  timeRange = NA,
  backsight = 50,
  changexpr = expression((t1/t0)^(1/d) - 1),
  gridclip = TRUE,
  raw = FALSE,
  model = c("exponential"),
  method = c("uncalsample"),
  predgrid = NA,
  normalised = NA,
  datenormalised = NA,
  spdnormalised = FALSE,
  ncores = 1,
  fitonly = FALSE,
  a = 0,
  b = 0,
  edgeSize = 500,
  verbose = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>A <code>CalDates</code> object containing calibrated radiocarbon ages</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>errors</code></td>
<td>
<p>A vector of errors corresponding to each radiocarbon age</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nsim</code></td>
<td>
<p>Number of simulations</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bins</code></td>
<td>
<p>A vector indicating which bin each radiocarbon date is assigned to.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>runm</code></td>
<td>
<p>A number indicating the window size of the moving average to smooth both observed and simulated SPDs. If set to <code>NA</code> no moving average is applied.Default is <code>NA</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>timeRange</code></td>
<td>
<p>A vector of length 2 indicating the start and end date of the analysis in cal BP. The fitting process is applied considering the SPD within the interval defined by this parameter. If no values are supplied the earliest and latest median calibrated dates of the observed data will be used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>backsight</code></td>
<td>
<p>A single numeric value defining the distance in time between the focal year and the backsight year for computing the rate of change. Default is 10.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>changexpr</code></td>
<td>
<p>An expression for calculating the rate of change in SPD between the focal year and a backsight year. Available input options are t1 (the SPD for the focal year), t0 (the SPD for the backsight year), d (the distance between t0 and t1), and any other standard constants and mathematical operators. A sensible default is provided.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gridclip</code></td>
<td>
<p>Whether the sampling of random dates is constrained to the observed range (TRUE) or not (FALSE). Default is TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>raw</code></td>
<td>
<p>A logical variable indicating whether all permuted SPDs should be returned or not. Default is FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>A vector indicating the model to be fitted. Currently the acceptable options are <code>'uniform'</code>, <code>'linear'</code>, <code>'exponential'</code> and <code>'custom'</code>. Default is <code>'exponential'</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>Method for the creation of random dates from the fitted model. Either <code>'uncalsample'</code> or <code>'calsample'</code>. Default is <code>'uncalsample'</code>. See below for details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>predgrid</code></td>
<td>
<p>A data.frame containing calendar years (column <code>calBP</code>) and associated summed probabilities (column <code>PrDens</code>). Required when <code>model</code> is set to <code>'custom'</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>normalised</code></td>
<td>
<p>Whether the simulated dates should be normalised or not. Default based on whether x is normalised or not.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>datenormalised</code></td>
<td>
<p>Argument kept for backward compatibility with previous versions.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>spdnormalised</code></td>
<td>
<p>A logical variable indicating whether the total probability mass of the SPD is normalised to sum to unity for both observed and simulated data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ncores</code></td>
<td>
<p>Number of cores used for for parallel execution. Default is 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fitonly</code></td>
<td>
<p>A logical variable. If set to TRUE, only the the model fitting is executed and returned. Default is FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>a</code></td>
<td>
<p>Starter value for the exponential fit with the <code>nls</code> function using the formula <code>y ~ exp(a + b * x)</code> where <code>y</code> is the summed probability and <code>x</code> is the date. Default is 0.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>b</code></td>
<td>
<p>Starter value for the exponential fit with the <code>nls</code> function using the formula <code>y ~ exp(a + b * x)</code> where <code>y</code> is the summed probability and <code>x</code> is the date. Default is 0.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>edgeSize</code></td>
<td>
<p>Controls edge effect by expanding the fitted model beyond the range defined by <code>timeRange</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>A logical variable indicating whether extra information on progress should be reported. Default is TRUE.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The function implements a Monte-Carlo test for comparing a theoretical or fitted statistical model to an observed summed radiocarbon date distribution (aka SPD) and associated rates of changes. A variety of theoretical expectations can be compared to the observed distribution by setting the <code>model</code> argument, for example to fit basic <code>'uniform'</code> (the mean of the SPD), <code>'linear'</code> (fitted using the <code>lm</code> function) or <code>model='exponential'</code> models (fitted using the <code>nls</code> function). Models are fitted to the period spanned by <code>timeRange</code> although <code>x</code> can contain dates outside this range to mitigate possible edge effects (see also <code>bracket</code>). Notice that estimating growth model parameters directly from SPD can be biased, resulting into a null hypothesis that is not necessarily representative (see Crema 2022). It is also possible for the user to provide a model of their own by setting <code>model='custom'</code> and then supplying a two-column data.frame to <code>predgrid</code>. The function generates <code>nsim</code> theoretical SPDs from the fitted model via Monte-Carlo simulation, this is then used to define a 95% critical envelope for each calendar year. The observed SPD is then compared against the simulation envelope; local departures from the model are defined as instances where the observed SPD is outside such an envelope, while an estimate of the global significance of the observed SPD is also computed by comparing the total areas of observed and simulated SPDs that fall outside the simulation envelope. The theoretical SPDs can be generated using two different sampling approaches defined by the parameter <code>method</code>. If <code>method</code> is set to <code>'uncalsample'</code> each date is drawn after the fitted model is backcalibrated as a whole and adjusted for a baseline expectation; if it is set to  <code>'calsample'</code> samples are drawn from the fitted model in calendar year then individually back calibrated and recalibrated (the approach of Timpson et al. 2014). For each simulation, both approaches produces <code class="reqn">n</code> samples, with <code class="reqn">n</code> equal to the number of bins or number of dates (when bins are not defined). Differences between these two approaches are particularly evident at dates coincident with steeper portions of the calibration curve. If more than one type of calibration curve is associated with the observed dates, at each Monte-Carlo iteration, the function randomly assigns each bin to one of the calibration curves with probability based on the proportion of dates within the bin associated to the specific curves. For example, if a bin is composed of four dates and three are calibrated with 'intcal20' the probability of that particular bin being assigned to 'intcal20' is 0.75.
</p>


<h3>Value</h3>

<p>An object of class <code>SpdModelTest</code> with the following elements
</p>

<ul>
<li>
<p><code>result</code> A four column data.frame containing the observed probability density (column <em>PrDens</em>) and the lower and the upper values of the simulation envelope (columns <em>lo</em> and <em>hi</em>) for each calendar year column <em>calBP</em>
</p>
</li>
<li>
<p><code>result.roc</code> A four column data.frame containing the observed rates of change (column <em>roc</em>) and the lower and the upper values of the simulation envelope (columns <em>lo.roc</em> and <em>hi.roc</em>) for the mid point between two chronological blocks <em>calBP</em>
</p>
</li>
<li>
<p><code>sim</code> A matrix containing the simulation results of the summed probabilities. Available only when <code>raw</code> is set to TRUE 
</p>
</li>
<li>
<p><code>sim.roc</code> A matrix containing the simulation results of the rate of change of summed probabilities. Available only when <code>raw</code> is set to TRUE 
</p>
</li>
<li>
<p><code>pval</code> A numeric vector containing the p-value of the global significance test for the summed probabilities  
</p>
</li>
<li>
<p><code>pval.roc</code> A numeric vector containing the p-value of the global significance test for the rates of change  
</p>
</li>
<li>
<p><code>fit</code> A data.frame containing the probability densities of the fitted model for each calendar year within the time range of analysis  
</p>
</li>
<li>
<p><code>fitobject</code> Fitted model. Not available when <code>model</code> is <code>'custom'</code>  
</p>
</li>
<li>
<p><code>n</code> Number of radiocarbon dates.
</p>
</li>
<li>
<p><code>nbins</code>Number of bins.
</p>
</li>
<li>
<p><code>nsim</code>Number of Monte-Carlo simulations.
</p>
</li>
<li>
<p><code>backsight</code>Backsight size. 
</p>
</li>
</ul>
<h3>Note</h3>


<ul>
<li> <p>Windows users might receive a memory allocation error with larger time span of analysis (defined by the parameter <code>timeRange</code>). This can be avoided by increasing the memory limit with the <code>memory.limit</code> function.
</p>
</li>
<li> <p>Users experiencing a <code>Error: cannot allocate vector of size ...</code> error message can increase the memory size using the <code>Sys.setenv()</code>, for example: <code>Sys.setenv("R_MAX_VSIZE" = 16e9)</code>. 
</p>
</li>
<li> <p>The function currently supports only dates calibrated with 'intcal20',intcal13','intcal13nhpine16','shcal20','shcal13','shcal13shkauri16', 'marine20', and 'marine13'.
</p>
</li>
</ul>
<h3>References</h3>

<p>Crema, E.R. (2022). Statistical inference of prehistoric demography from frequency distributions of radiocarbon dates: a review and a guide for the perplexed. Journal of Archaeological Method and Theory. doi:10.1007/s10816-022-09559-5
</p>
<p>Timpson, A., Colledge, S., Crema, E., Edinborough, K., Kerig, T., Manning, K., Thomas, M.G., Shennan, S., (2014). Reconstructing regional population fluctuations in the European Neolithic using radiocarbon dates: a new case-study using an improved method. Journal of Archaeological Science, 52, 549-557. doi:10.1016/j.jas.2014.08.011
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Example with Younger Dryas period Near East, including site bins
## Not run: 
data(emedyd)
caldates &lt;- calibrate(x=emedyd$CRA, errors=emedyd$Error, normalised=FALSE)
bins &lt;- binPrep(sites=emedyd$SiteName, ages=emedyd$CRA, h=50)
nsim=5 #toy example
expnull &lt;- modelTest(caldates, errors=emedyd$Error, bins=bins, nsim=nsim, runm=50,
timeRange=c(16000,9000), model="exponential", datenormalised=FALSE)
plot(expnull, xlim=c(16000,9000))
round(expnull$pval,4) #p-value
summary(expnull)

## End(Not run)
</code></pre>


</div>