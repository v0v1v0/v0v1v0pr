<div class="container">

<table style="width: 100%;"><tr>
<td>sptest</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Spatial Permutation Test of summed probability distributions.</h2>

<h3>Description</h3>

<p>This function carries out local spatial permutation tests of summed radiocarbon probability distributions in order to detect local deviations in growth rates (Crema et al 2017).
</p>


<h3>Usage</h3>

<pre><code class="language-R">sptest(
  calDates,
  timeRange,
  bins,
  locations,
  locations.id.col = NULL,
  breaks,
  h,
  kernel = "gaussian",
  rate = expression((t2/t1)^(1/d) - 1),
  nsim = 1000,
  runm = NA,
  permute = "locations",
  ncores = 1,
  datenormalised = FALSE,
  verbose = TRUE,
  raw = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>calDates</code></td>
<td>
<p>A <code>CalDates</code> class object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>timeRange</code></td>
<td>
<p>A vector of length 2 indicating the start and end date of the analysis in cal BP</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bins</code></td>
<td>
<p>A vector indicating which bin each radiocarbon date is assigned to. Must have the same length as the number of radiocarbon dates. Can be created using the  <code>binPrep</code>) function. Bin names should follow the format "x_y", where x refers to a unique location (e.g. a site) and y is a integer value (e.g. "S023_1", "S023_2","S034_1", etc.).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>locations</code></td>
<td>
<p>A <code>sf</code> class object of the site locations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>locations.id.col</code></td>
<td>
<p>Column name containing the first part of the supplied bin names. If missing rownames are used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>breaks</code></td>
<td>
<p>A vector of break points for defining the temporal slices.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>h</code></td>
<td>
<p>distance parameter for calculating spatial weights.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>kernel</code></td>
<td>
<p>indicates the type of weighting function, either 'fixed' or 'gaussian'. When set to "fixed" weight is equal to 1 within a radius of <code>h</code> km from each focal sie, and 0 outside this range. When set "gaussian" the weight declines with an exponential rate equal to exp(-d^2/h^2), where the d is the distance to the focal site. Default is "gaussian".</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rate</code></td>
<td>
<p>An expression defining how the rate of change is calculated, where <code>t1</code> is the summed probability for a focal block, <code>t2</code> is the summed probability for next block, and <code>d</code> is the duration of the blocks. Default is a geometric growth rate (i.e <code>expression((t2/t1)^(1/d)-1)</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nsim</code></td>
<td>
<p>The total number of simulations. Default is 1000.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>runm</code></td>
<td>
<p>The window size of the moving window average. Must be set to <code>NA</code> if the rates of change are calculated from the raw SPDs.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>permute</code></td>
<td>
<p>Indicates whether the permutations should be based on the <code>"bins"</code> or the <code>"locations"</code>. Default is <code>"locations"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ncores</code></td>
<td>
<p>Number of cores used for for parallel execution. Default is 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>datenormalised</code></td>
<td>
<p>A logical variable indicating whether the probability mass of each date within <code>timeRange</code> is equal to 1. Default is FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>A logical variable indicating whether extra information on progress should be reported. Default is TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>raw</code></td>
<td>
<p>A logical variable indicating whether permuted sets of geometric growth rates for each location should be returned. Default is FALSE.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The function consists of the following seven steps: 1) generate a weight matrix based on inter-site distance; 2) for each location (e.g. a site) generate a local SPD of radiocarbon dates, weighting the contribution of dates from neighbouring sites using a weight scheme computed in step 1; 3) define temporal slices (using <code>breaks</code> as break values), then compute the total probability mass within each slice; 4) compute the rate of change between abutting temporal slices by using the formula: <code class="reqn">(SPD_{t}/SPD_{t+1}^{1/\Delta t}-1)</code>; 5) randomise the location of individual bins or the entire sequence of bins associated with a given location and carry out steps 2 to 4; 6) repeat step 5 <code>nsim</code> times and generate, for each location, a distribution of growth rates under the null hypothesis (i.e. spatial independence); 7) compare, for each location, the observed growth rate with the distribution under the null hypothesis and compute the p-values; and 8) compute the false-discovery rate for each location.
</p>


<h3>Value</h3>

<p>A <code>spatialTest</code> class object
</p>


<h3>References</h3>

<p>Crema, E.R., Bevan, A., Shennan, S. (2017). Spatio-temporal approaches to archaeological radiocarbon dates. Journal of Archaeological Science, 87, 1-9.
</p>


<h3>See Also</h3>

<p><code>permTest</code> for a non-spatial permutation test; <code>plot.spatialTest</code> for plotting; <code>spd2rc</code> for computing geometric growth rates.
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Reproduce Crema et al 2017 ##
## Not run: 
data(euroevol) #load data

## Subset only for ca 8000 to 5000 Cal BP (7500-4000 14C Age)
euroevol2=subset(euroevol,C14Age&lt;=7500&amp;C14Age&gt;=4000)

## define chronological breaks
breaks=seq(8000,5000,-500)

## Create a sf class object 
library(sf)
sites.df = unique(data.frame(SiteID=euroevol2$SiteID,
Longitude=euroevol2$Longitude,Latitude=euroevol2$Latitude))
sites.sf = st_as_sf(sites.df,coords=c('Longitude','Latitude'),crs=4326) 

## Calibration and binning
bins=binPrep(sites=euroevol2$SiteID,ages=euroevol2$C14Age,h=200)  
calDates=calibrate(x=euroevol2$C14Age,errors=euroevol2$C14SD,normalised=FALSE)

## Main Analysis (over 2 cores; requires doSnow package) 
## NOTE: the number of simulations should be ideally larger 
## to ensure more accurate and precise estimates of the p/q-values.
res.locations=sptest(calDates,timeRange=c(8000,5000),bins=bins,
locations=sites.sf,locations.id.col="SiteID",h=100,breaks=breaks,ncores=2,nsim=100,
permute="locations",datenormalised=FALSE)

## Plot results
library(rnaturalearth)
win  &lt;- ne_countries(continent = 'europe',scale=10,returnclass='sf')
#retrieve coordinate limits
xrange &lt;- st_bbox(sites.sf)[c(1,3)]
yrange &lt;- st_bbox(sites.sf)[c(2,4)]

par(mfrow=c(1,2))  
par(mar=c(0.1,0.1,0,0.5))
plot(sf::st_geometry(win),col="antiquewhite3",border="antiquewhite3",xlim=xrange,ylim=yrange)
plot(res.locations,index=4,add=TRUE,legend=TRUE,option="raw",breakRange=c(-0.005,0.005)) 
plot(sf::st_geometry(win),col="antiquewhite3",border="antiquewhite3",xlim=xrange,ylim=yrange) 
plot(res.locations,index=4,add=TRUE,legend=TRUE,option="test")  

## End(Not run)
</code></pre>


</div>