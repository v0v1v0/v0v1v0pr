<div class="container">

<table style="width: 100%;"><tr>
<td>R.s.estimate</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>

Calculates the proportion of treatment effect explained
</h2>

<h3>Description</h3>


<p>This function calculates the proportion of treatment effect on the primary outcome explained by the treatment effect on the surrogate marker(s). This function is intended to be used for a fully observed continuous outcome. The user can also request a variance estimate and a 95% confidence interval, both estimated using perturbating-resampling. If a confidence interval is requested three versions are provided: a normal approximation based interval, a quantile based interval, and Fieller's confidence interval.
</p>


<h3>Usage</h3>

<pre><code class="language-R">R.s.estimate(sone, szero, yone, yzero, var = FALSE, conf.int = FALSE, 
weight.perturb = NULL, number = "single", type = "robust",extrapolate = FALSE, 
transform = FALSE,warn.te = FALSE, warn.support = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>sone</code></td>
<td>


<p>numeric vector or matrix; surrogate marker for treated observations, assumed to be continuous. If there are multiple surrogates then this should be a matrix with <code class="reqn">n_1</code> (number of treated observations) rows and n.s (number of surrogate markers) columns.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>szero</code></td>
<td>


<p>numeric vector; surrogate marker for control observations, assumed to be continuous.If there are multiple surrogates then this should be a matrix with <code class="reqn">n_0</code> (number of control observations) rows and n.s (number of surrogate markers) columns. 
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>yone</code></td>
<td>


<p>numeric vector; primary outcome for treated observations, assumed to be continuous.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>yzero</code></td>
<td>


<p>numeric vector; primary outcome for control observations, assumed to be continuous.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>var</code></td>
<td>


<p>TRUE or FALSE; indicates whether a variance estimate is requested, default is FALSE.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.int</code></td>
<td>


<p>TRUE or FALSE; indicates whether a 95% confidence interval is requested, default is FALSE
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weight.perturb</code></td>
<td>


<p>a <code class="reqn">n_1+n_0</code> by <code class="reqn">x</code> matrix of weights where <code class="reqn">n_1 = </code> length of yone and <code class="reqn">n_0 = </code>  length of yzero; used for perturbation-resampling, default is null.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>number</code></td>
<td>


<p>specifies the number of surrogate markers; choices are "multiple" or "single", default is "single" 
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>type</code></td>
<td>


<p>specifies the type of estimation; choices are "robust" or "model" or "freedman", default is "robust"
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>extrapolate</code></td>
<td>


<p>TRUE or FALSE; indicates whether the user wants to use extrapolation.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>transform</code></td>
<td>


<p>TRUE or FALSE; indicates whether the user wants to use a transformation for the surrogate marker. 
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>warn.te</code></td>
<td>


<p>value to control warnings; user does not need to specify.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>warn.support</code></td>
<td>


<p>value to control warnings; user does not need to specify.
</p>
</td>
</tr>
</table>
<h3>Details</h3>


<p>Let <code class="reqn">Y^{(1)}</code> and <code class="reqn">Y^{(0)}</code> denote the primary outcome under the treatment and primary outcome under the control,respectively. Let <code class="reqn">S^{(1)}</code> and <code class="reqn">S^{(0)}</code> denote the surrogate marker under the treatment and the surrogate marker under the control,respectively. The residual treatment effect is defined as
</p>
<p style="text-align: center;"><code class="reqn"> \Delta_S=\int_{-\infty}^{\infty}  E(Y^{(1)}|S^{(1)}=s) dF_0(s)  - \int_{-\infty}^{\infty} E(Y^{(0)}|S^{(0)}=s) dF_0(s),</code>
</p>

<p>where <code class="reqn">\Delta_S(s)= E(Y^{(1)}|S^{(1)}=s)-E(Y^{(0)}|S^{(0)}=s)</code>  and <code class="reqn">F_0(\cdot)</code> is the marginal cumulative distribution function of <code class="reqn">S^{(0)}</code>, the surrogate marker measure under the control. The proportion of treatment effect explained by the surrogate marker, which we denote by <code class="reqn">R_S</code>, can be expressed using a contrast between <code class="reqn">\Delta_S</code> and <code class="reqn">\Delta</code>:
</p>
<p style="text-align: center;"><code class="reqn">R_S=\{\Delta-\Delta_S\}/\Delta=1-\Delta_S/\Delta.</code>
</p>
<p>   The definition and estimation of <code class="reqn">\Delta</code> is described in the delta.estimate documentation.
</p>
<p>A flexible model-based approach to estimate <code class="reqn">\Delta_S</code> in the single marker setting is to specify:
</p>
<p style="text-align: center;"><code class="reqn">E(S^{(0)})=\alpha_0 \quad\mbox{and}\quad E(S^{(1)})-E(S^{(0)}) = \alpha_1,</code>
</p>

<p style="text-align: center;"><code class="reqn"> E(Y^{(0)} | S^{(0)}) = \beta_0 + \beta_1 S^{(0)}  \quad \mbox{and} \quad  E(Y^{(1)} | S^{(1)}) = (\beta_0 +\beta_2)+ (\beta_1+\beta_3) S^{(1)}. </code>
</p>

<p>It can be shown that when these models hold, <code class="reqn">\Delta_S = \beta_2 + \beta_3 \alpha_0</code>. Thus, reasonable estimates for <code class="reqn">\Delta_S</code> and <code class="reqn">R_S</code> using this approach would be <code class="reqn">\hat{\Delta}_S =  \hat{\beta}_2 + \hat{\beta}_3 \hat{\alpha}_0</code> and <code class="reqn">\hat{R}_S = 1-\hat{\Delta}_S / \hat{\Delta}.</code> 
</p>
<p>For robust estimation of <code class="reqn">\Delta_S</code> in the single marker setting, we estimate <code class="reqn">\mu_1(s) = E(Y^{(1)}|S^{(1)}=s)</code> nonparametrically using kernel smoothing: 
</p>
<p style="text-align: center;"><code class="reqn">\hat{\mu}_1(s) = \frac{\sum_{i=1}^{n_1} K_h\left (S_{1i}-s \right ) Y_{1i} }{\sum_{i=1}^{n_1} K_h\left (S_{1i}-s \right )}</code>
</p>

<p>where <code class="reqn">S_{1i}</code> is the observed <code class="reqn">S^{(1)}</code> for person <code class="reqn">i</code>, <code class="reqn">Y_{1i}</code> is the observed <code class="reqn">Y^{(1)}</code> for person <code class="reqn">i</code>, <code class="reqn">K(\cdot)</code> is a smooth symmetric density function with finite support, <code class="reqn">K_h(\cdot)=K(\cdot/h)/h</code> and <code class="reqn">h</code> is a specified bandwidth. As in most nonparametric functional estimation procedures, the choice of the smoothing parameter <code class="reqn">h</code>  is critical. To eliminate the impact of the bias of the conditional mean function on the resulting estimator, we require the standard undersmoothing assumption of <code class="reqn">h=O(n_1^{-\delta})</code> with <code class="reqn">\delta \in (1/4,1/3).</code>  To obtain an appropriate <code class="reqn">h</code> we first use bw.nrd to obtain <code class="reqn">h_{opt}</code>; and then we let <code class="reqn">h = h_{opt}n_1^{-c_0}</code>  with <code class="reqn">c_0 = 0.25</code>. We then estimate <code class="reqn">\Delta_S</code> as
</p>
<p style="text-align: center;"><code class="reqn"> \hat{\Delta}_S= \sum_{i=1}^{n_0} \frac{\hat{\mu}_1(S_{0i})- Y_{0i}}{n_0}</code>
</p>
<p> where <code class="reqn">S_{0i}</code> is the observed <code class="reqn">S^{(0)}</code> for person <code class="reqn">i</code> and <code class="reqn">Y_{0i}</code> is the observed <code class="reqn">Y^{(0)}</code> for person <code class="reqn">i</code>. Lastly, we estimate <code class="reqn">R_S</code> as <code class="reqn">\hat{R}_S = 1-\hat{\Delta}_S/\hat{\Delta}</code>.
</p>
<p>This function also allows for estimation of <code class="reqn">R_S</code> using Freedman's approach.  Let <code class="reqn">Y</code> denote the primary outcome, <code class="reqn">S</code> denote the surrogate marker, and <code class="reqn">G</code> denote the treatment group (0 for control, 1 for treatment). Freedman's approach to calculating the proportion of treatment effect explained by the surrogate marker is to fit the following two regression models:
</p>
<p style="text-align: center;"><code class="reqn">E(Y|G) = \gamma_0 + \gamma_1 I(G=1) \quad \mbox{and} \quad E(Y|G, S) = \gamma_{0S} + \gamma_{1S}I(G=1) + \gamma_{2S} S </code>
</p>

<p>and estimating the proportion of treatment effect explained, denoted by <code class="reqn">R_S</code>, as <code class="reqn"> 1-\hat{\gamma}_{1S}/\hat{\gamma}_1</code>.
</p>
<p>This function also estimates <code class="reqn">R_S</code> in a multiple marking setting. A flexible model-based approach to estimate <code class="reqn">\Delta_S</code> in the multiple marker setting is to specify models for <code class="reqn">E(Y|G, S)</code> and <code class="reqn">E(S_j | G)</code> for each <code class="reqn">S_j</code> in <code class="reqn">S = \{S_1,...S_p\}</code> (where p is the number of surrogate markers). Without loss of generality, consider the case where there are three surrogate markers, <code class="reqn">S = \{S_1, S_2, S_3\}</code> and one specifies the following linear models:
</p>
<p style="text-align: center;"><code class="reqn">E(Y^{(0)} | S^{(0)}) = \beta_0 + \beta_1 S_1^{(0)} + \beta_2 S_2^{(0)} +  \beta_3 S_3^{(0)}</code>
</p>

<p style="text-align: center;"><code class="reqn">E(Y^{(1)} | S^{(1)}) = (\beta_0+\beta_4) + (\beta_1+\beta_5) S_1^{(1)} + (\beta_2+\beta_6) S_2^{(1)} +  (\beta_3+\beta_7) S_3^{(1)}</code>
</p>

<p style="text-align: center;"><code class="reqn"> E(S_j^{(0)}) = \alpha_j, ~~~~j=1,2,3.</code>
</p>
 
<p>It can be shown that when these models hold 
</p>
<p style="text-align: center;"><code class="reqn">\Delta_{S} = \beta_4 + \beta_5\alpha_1 + \beta_6 \alpha_2 + \beta_7 \alpha_3.</code>
</p>
<p> Thus, reasonable estimates for <code class="reqn">\Delta_{S}</code> and <code class="reqn">R_{S}</code> here would be easily obtained by replacing the unknown regression coefficients in the models above by their consistent estimators. 
</p>
<p>For robust estimation of S <code class="reqn">\Delta_S</code> in the multiple marker setting, we use a two-stage procedure combining the model-based approach and the nonparametric estimation procedure from the single marker setting. Specifically, we use a working semiparametric  model: </p>
<p style="text-align: center;"><code class="reqn">E(Y^{(1)}|S^{(1)}=S)=\beta_0 + \beta_1 S_1^{(1)} + \beta_2 S_2^{(1)} +  \beta_3 S_3^{(1)}</code>
</p>
 
<p>and define <code class="reqn">Q^{(1)} = \hat{\beta}_0 + \hat{\beta}_1 S_1^{(1)} + \hat{\beta}_2 S_2^{(1)} +  \hat{\beta}_3 S_3^{(1)}</code> and <code class="reqn">Q^{(0)} = \hat{\beta}_0 + \hat{\beta}_1 S_1^{(0)} + \hat{\beta}_2 S_2^{(0)} +  \hat{\beta}_3 S_3^{(0)}</code> to reduce the dimension of <code class="reqn">S</code> in the first stage  and in the second stage, we apply the robust approach used in the single marker setting to  estimate its surrogacy. 
</p>
<p>To use Freedman's approach in the presence of multiple markers, the markers are simply additively entered into the second regression model.
</p>
<p>Variance estimation and confidence interval construction are performed using perturbation-resampling. Specifically, let <code class="reqn">\left \{ V^{(b)} = (V_{11}^{(b)}, ...V_{1n_1}^{(b)}, V_{01}^{(b)}, ...V_{0n_0}^{(b)})^T, b=1,....,D \right \}</code> be <code class="reqn">n \times D</code> independent copies of a positive random variables <code class="reqn">V</code> from a known distribution with unit mean and unit variance. Let
</p>
<p style="text-align: center;"><code class="reqn">\hat{\Delta}^{(b)}  = \frac{  \sum_{i=1}^{n_1} V_{1i}^{(b)} Y_{1i}}{ \sum_{i=1}^{n_1} V_{1i}^{(b)}}  - \frac{  \sum_{i=1}^{n_0} V_{0i}^{(b)} Y_{0i}}{ \sum_{i=1}^{n_0} V_{0i}^{(b)}}.</code>
</p>
<p> The variance of <code class="reqn">\hat{\Delta}</code> is obtained as the empirical variance of <code class="reqn">\{\hat{\Delta}^{(b)}, b = 1,...,D\}.</code> In this package, we use weights generated from an Exponential(1) distribution and use <code class="reqn">D=500</code>. Variance estimates for <code class="reqn">\hat{\Delta}_S</code> and <code class="reqn">\hat{R}_S</code> are calculated similarly. We construct two versions of the <code class="reqn">95\%</code> confidence interval for each estimate: one based on a normal approximation confidence interval using the estimated variance and another taking the 2.5th and 97.5th empirical percentile of the perturbed quantities.  In addition, we use Fieller's method to obtain a third confidence interval for <code class="reqn">R_S</code> as
</p>
<p style="text-align: center;"><code class="reqn">\left\{1-r:  \frac{(\hat{\Delta}_S-r\hat{\Delta})^2}{\hat{\sigma}_{11}-2r\hat\sigma_{12}+r^2\hat\sigma_{22}} \le c_{\alpha}\right\},</code>
</p>

<p>where <code class="reqn">\hat{\Sigma}=(\hat\sigma_{ij})_{1\le i,j\le 2}</code> and <code class="reqn">c_\alpha</code> is the <code class="reqn">(1-\alpha)</code>th percentile of
</p>
<p style="text-align: center;"><code class="reqn">\left\{\frac{\{\hat{\Delta}^{(b)}_S-(1-\hat R_S)\hat{\Delta}^{(b)}\}^2}{\hat{\sigma}_{11}-2(1-\hat R_S)\hat\sigma_{12}+(1-\hat R_S)^2\hat\sigma_{22}}, b=1, \cdots, C\right\}</code>
</p>

<p>where <code class="reqn">\alpha=0.05</code>.
</p>
<p>Note that if the observed supports for S are not the same, then <code class="reqn">\hat{\mu}_1(s)</code> for <code class="reqn">S_{0i} = s</code> outside the support of <code class="reqn">S_{1i}</code> may return NA (depending on the bandwidth). If extrapolation = TRUE, then the   <code class="reqn">\hat{\mu}_1(s)</code> values for these surrogate values are set to the closest non-NA value. If transform = TRUE, then <code class="reqn">S_{1i}</code> and <code class="reqn">S_{0i}</code> are transformed such that the new transformed values, <code class="reqn">S^{tr}_{1i}</code> and <code class="reqn">S^{tr}_{0i}</code> are defined as: <code class="reqn">S^{tr}_{gi} = F([S_{gi} - \mu]/\sigma)</code> for <code class="reqn">g=0,1</code> where <code class="reqn">F(\cdot)</code> is the cumulative distribution function for a standard normal random variable, and <code class="reqn">\mu</code> and <code class="reqn">\sigma</code> are the sample mean and standard deviation, respectively, of <code class="reqn">(S_{1i}, S_{0i})^T</code>.
</p>


<h3>Value</h3>






<p>A list is returned:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>R.s </code></td>
<td>
<p>the estimate, <code class="reqn">\hat{R}_S</code>, described above.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>R.s.var </code></td>
<td>
<p>the variance estimate of <code class="reqn">\hat{R}_S</code>; if var = TRUE or conf.int = TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.int.normal.R.s</code></td>
<td>
<p>a vector of size 2; the 95% confidence interval for <code class="reqn">\hat{R}_S</code> based on a normal approximation; if conf.int = TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.int.quantile.R.s</code></td>
<td>
<p>a vector of size 2; the 95% confidence interval for <code class="reqn">\hat{R}_S</code> based on sample quantiles of the perturbed values, described above; if conf.int = TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.int.fieller.R.s</code></td>
<td>
<p>a vector of size 2; the 95% confidence interval for <code class="reqn">\hat{R}_S</code> based on Fieller's approach, described above; if conf.int = TRUE.</p>
</td>
</tr>
</table>
<p>For all options other then "freedman", the following are also returned:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>delta </code></td>
<td>
<p>the estimate, <code class="reqn">\hat{\Delta}</code>, described in delta.estimate documentation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>delta.s </code></td>
<td>
<p>the estimate, <code class="reqn">\hat{\Delta}_S</code>, described above.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>delta.var </code></td>
<td>
<p>the variance estimate of <code class="reqn">\hat{\Delta}</code>; if var = TRUE or conf.int = TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>delta.s.var </code></td>
<td>
<p>the variance estimate of <code class="reqn">\hat{\Delta}_S</code>; if var = TRUE or conf.int = TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.int.normal.delta</code></td>
<td>
<p>a vector of size 2; the 95% confidence interval for <code class="reqn">\hat{\Delta}</code> based on a normal approximation; if conf.int = TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.int.quantile.delta</code></td>
<td>
<p>a vector of size 2; the 95% confidence interval for <code class="reqn">\hat{\Delta}</code> based on sample quantiles of the perturbed values, described above; if conf.int = TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.int.normal.delta.s</code></td>
<td>
<p>a vector of size 2; the 95% confidence interval for <code class="reqn">\hat{\Delta}_S</code> based on a normal approximation; if conf.int = TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.int.quantile.delta.s</code></td>
<td>
<p>a vector of size 2; the 95% confidence interval for <code class="reqn">\hat{\Delta}_S</code> based on sample quantiles of the perturbed values, described above; if conf.int = TRUE.</p>
</td>
</tr>
</table>
<h3>Note</h3>

<p> If the treatment effect is not significant, the user will receive the following message: "Warning: it looks like the treatment effect is not significant; may be difficult to interpret the proportion of treatment effect explained in this setting". In the single marker case with the robust estimation approach, if the observed support of the surrogate marker for the control group is outside the observed support of the surrogate marker for the treatment group, the user will receive the following message: "Warning: observed supports do not appear equal, may need to consider a transformation or extrapolation"</p>


<h3>Author(s)</h3>


<p>Layla Parast
</p>


<h3>References</h3>


<p>Freedman, L. S., Graubard, B. I., &amp; Schatzkin, A. (1992). Statistical validation of intermediate endpoints for chronic diseases. Statistics in medicine, 11(2), 167-178.
</p>
<p>Parast, L., McDermott, M., Tian, L. (2016). Robust estimation of the proportion of treatment effect explained by surrogate marker information. Statistics in Medicine, 35(10):1637-1653.
</p>
<p>Wang, Y., &amp; Taylor, J. M. (2002). A measure of the proportion of treatment effect explained by a surrogate marker. Biometrics, 58(4), 803-812.
</p>
<p>Fieller, Edgar C. (1954). Some problems in interval estimation. Journal of the Royal Statistical Society. Series B (Methodological), 175-185.
</p>
<p>Fieller, E. C. (1940). The biological standardization of insulin. Supplement to the Journal of the Royal Statistical Society, 1-64.
</p>


<h3>Examples</h3>

<pre><code class="language-R">data(d_example)
names(d_example)
R.s.estimate(yone=d_example$y1, yzero=d_example$y0, sone=d_example$s1.a, szero=d_example$s0.a, 
number = "single", type = "robust")
R.s.estimate(yone=d_example$y1, yzero=d_example$y0, sone=cbind(d_example$s1.a,d_example$s1.b, 
d_example$s1.c), szero=cbind(d_example$s0.a, d_example$s0.b, d_example$s0.c), 
number = "multiple", type = "model")
</code></pre>


</div>