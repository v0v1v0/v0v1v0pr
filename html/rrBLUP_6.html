<div class="container">

<table style="width: 100%;"><tr>
<td>mixed.solve</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Mixed-model solver
</h2>

<h3>Description</h3>

<p>Calculates maximum-likelihood (ML/REML) solutions for mixed models of the form
</p>
<p style="text-align: center;"><code class="reqn">y = X \beta + Z u + \varepsilon</code>
</p>

<p>where <code class="reqn">\beta</code> is a vector of fixed effects and <code class="reqn">u</code> is a vector of random effects with 
<code class="reqn">Var[u] = K \sigma^2_u</code>.  The residual variance is <code class="reqn">Var[\varepsilon] = I \sigma^2_e</code>.  This class
of mixed models, in which there is a single variance component other than the residual error,
has a close relationship with ridge regression (ridge parameter <code class="reqn">\lambda = \sigma_e^2 / \sigma^2_u</code>).
</p>


<h3>Usage</h3>

<pre><code class="language-R">mixed.solve(y, Z=NULL, K=NULL, X=NULL, method="REML", 
        bounds=c(1e-09, 1e+09), SE=FALSE, return.Hinv=FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>y</code></td>
<td>

<p>Vector (<code class="reqn">n \times 1</code>) of observations.  Missing values (NA) are omitted, along with the corresponding rows of X and Z. 
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Z</code></td>
<td>

<p>Design matrix (<code class="reqn">n \times m</code>) for the random effects.  If not passed, assumed to be the identity matrix.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>K</code></td>
<td>

<p>Covariance matrix (<code class="reqn">m \times m</code>) for random effects; must be positive semi-definite.  If not passed, assumed to 
be the identity matrix.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>X</code></td>
<td>

<p>Design matrix (<code class="reqn">n \times p</code>) for the fixed effects.  If not passed, a vector of 1's is used
to model the intercept.  X must be full column rank (implies <code class="reqn">\beta</code> is estimable).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>

<p>Specifies whether the full ("ML") or restricted ("REML") maximum-likelihood method is used.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bounds</code></td>
<td>

<p>Array with two elements specifying the lower and upper bound for the ridge parameter.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>SE</code></td>
<td>

<p>If TRUE, standard errors are calculated.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>return.Hinv</code></td>
<td>

<p>If TRUE, the function returns the inverse of <code class="reqn">H = Z K Z' + \lambda I</code>.  This is useful for <code>GWAS</code>.
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This function can be used to predict marker effects or breeding values (see examples).  The numerical method 
is based on the spectral decomposition of <code class="reqn">Z K Z'</code> and <code class="reqn">S Z K Z' S</code>, where <code class="reqn">S = I - X (X' X)^{-1} X'</code> is 
the projection operator for the nullspace of <code class="reqn">X</code> (Kang et al., 2008). This algorithm generates the inverse phenotypic covariance matrix <code class="reqn">V^{-1}</code>, which can then be used to calculate the BLUE and BLUP solutions for the fixed and random effects, respectively, using standard formulas (Searle et al. 1992):
</p>
<p style="text-align: center;"><code class="reqn">BLUE(\beta) = \beta^* = (X'V^{-1}X)^{-1}X'V^{-1}y</code>
</p>

<p style="text-align: center;"><code class="reqn">BLUP(u) = u^* = \sigma^2_u KZ'V^{-1}(y-X\beta^*)</code>
</p>

<p>The standard errors are calculated as the square root of the diagonal elements of the following matrices (Searle et al. 1992):
</p>
<p style="text-align: center;"><code class="reqn">Var[\beta^*] = (X'V^{-1}X)^{-1}</code>
</p>

<p style="text-align: center;"><code class="reqn">Var[u^*-u] = K \sigma^2_u - \sigma^4_u KZ'V^{-1}ZK + \sigma^4_u KZ'V^{-1}XVar[\beta^*]X'V^{-1}ZK</code>
</p>

<p>For marker effects where K = I, the function will run faster if K is not passed than if the user passes the identity matrix.
</p>


<h3>Value</h3>

<p>If SE=FALSE, the function returns a list containing
</p>

<dl>
<dt>$Vu</dt>
<dd>
<p>estimator for <code class="reqn">\sigma^2_u</code></p>
</dd>
<dt>$Ve</dt>
<dd>
<p>estimator for <code class="reqn">\sigma^2_e</code></p>
</dd>
<dt>$beta</dt>
<dd>
<p>BLUE(<code class="reqn">\beta</code>)</p>
</dd>
<dt>$u</dt>
<dd>
<p>BLUP(<code class="reqn">u</code>)</p>
</dd>
<dt>$LL</dt>
<dd>
<p>maximized log-likelihood (full or restricted, depending on method)</p>
</dd>
</dl>
<p>If SE=TRUE, the list also contains
</p>

<dl>
<dt>$beta.SE</dt>
<dd>
<p>standard error for <code class="reqn">\beta</code></p>
</dd>
<dt>$u.SE</dt>
<dd>
<p>standard error for <code class="reqn">u^*-u</code></p>
</dd>
</dl>
<p>If return.Hinv=TRUE, the list also contains
</p>

<dl>
<dt>$Hinv</dt>
<dd>
<p>the inverse of <code class="reqn">H</code></p>
</dd>
</dl>
<h3>References</h3>

<p>Kang et al. 2008. Efficient control of population structure in model organism association mapping. 
Genetics 178:1709-1723.
</p>
<p>Endelman, J.B. 2011. Ridge regression and other kernels for genomic selection with R package rrBLUP. Plant Genome 4:250-255.
</p>
<p>Searle, S.R., G. Casella and C.E. McCulloch. 1992. Variance Components. John Wiley, Hoboken.
</p>


<h3>Examples</h3>

<pre><code class="language-R">#random population of 200 lines with 1000 markers
M &lt;- matrix(rep(0,200*1000),200,1000)
for (i in 1:200) {
  M[i,] &lt;- ifelse(runif(1000)&lt;0.5,-1,1)
}

#random phenotypes
u &lt;- rnorm(1000)
g &lt;- as.vector(crossprod(t(M),u))
h2 &lt;- 0.5  #heritability
y &lt;- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))

#predict marker effects
ans &lt;- mixed.solve(y,Z=M)  #By default K = I
accuracy &lt;- cor(u,ans$u)

#predict breeding values
ans &lt;- mixed.solve(y,K=A.mat(M))
accuracy &lt;- cor(g,ans$u)

</code></pre>


</div>