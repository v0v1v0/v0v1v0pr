<div class="container">

<table style="width: 100%;"><tr>
<td>fieldCastingFunctions</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Functions for Casting Fields After Export (Post Processing)</h2>

<h3>Description</h3>

<p>The functions provided here allow for recasting fields
after records have been exported. They generally have a similar
interface to the casting strategy of <code>exportRecordsTyped()</code>,
though they may not each offer all the same options.
</p>


<h3>Usage</h3>

<pre><code class="language-R">recastRecords(
  data,
  rcon,
  fields,
  cast = list(),
  suffix = "",
  warn_zero_coded = TRUE
)

castForImport(
  data,
  rcon,
  fields = NULL,
  na = list(),
  validation = list(),
  cast = list(),
  warn_zero_coded = TRUE
)

guessCast(
  data,
  rcon,
  na = isNAorBlank,
  validation,
  cast,
  quiet = FALSE,
  threshold = 0.8
)

guessDate(
  data,
  rcon,
  na = isNAorBlank,
  validation = valRx("^[0-9]{1,4}-(0?[1-9]|1[012])-(0?[1-9]|[12][0-9]|3[01])$"),
  cast = function(x, ...) as.POSIXct(x, format = "%Y-%m-%d"),
  quiet = FALSE,
  threshold = 0.8
)

mChoiceCast(data, rcon, style = "labelled", drop_fields = TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p><code>data.frame</code> with the data fields to be recoded.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rcon</code></td>
<td>
<p>A <code>redcapConnection</code> object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fields</code></td>
<td>
<p><code>character/logical/integerish</code>. A vector for identifying
which fields to recode. When <code>logical</code>, the length must match
the number of columns in <code>data</code> (i.e., recycling not permitted).
A message is printed if any of the indicated fields are not a
multiple choice field; no action will be taken on such fields.
For this function, yes/no and true/false fields are considered
multiple choice fields. Fields of class <code>mChoice</code> are quietly skipped.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cast</code></td>
<td>
<p>A named <code>list</code> of user specified class casting functions. The
same named keys are supported as the na argument. The function will be
provided the variables (x, field_name, coding). The function must return a
vector of logical matching the input length. The cast should match the validation,
if one is using <code>raw_cast</code>, then <code>validation=skip_validation</code> is likely
the desired intent. See <code>fieldValidationAndCasting()</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>suffix</code></td>
<td>
<p><code>character(1)</code>. An optional suffix to provide if
the recoded variables should be returned as new columns. For example,
if recoding a field <code>forklift_brand</code> and <code>suffix = "_labeled"</code>,
the result will have one column with the coded values
(<code>forklift_brand</code>) and one column with the labeled values
(<code>forklift_brand_labeled</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>warn_zero_coded</code></td>
<td>
<p>logical(1). Turn on or off warnings about zero coded fields. Default is TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>na</code></td>
<td>
<p>A named <code>list</code> of user specified functions to determine if the
data is NA. This is useful when data is loaded that has coding for NA, e.g.
-5 is NA. Keys must correspond to a truncated REDCap field type, i.e.
date_, datetime_, datetime_seconds_, time_mm_ss, time_hh_mm_ss, time, float,
number, calc, int, integer, select, radio, dropdown, yesno, truefalse,
checkbox, form_complete, sql, system. The function will be provided the
variables (x, field_name, coding). The function must return a vector of
logicals matching the input. It defaults to <code>isNAorBlank()</code> for all
entries.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>validation</code></td>
<td>
<p>A named <code>list</code> of user specified validation functions. The
same named keys are supported as the na argument. The function will be
provided the variables (x, field_name, coding). The function must return a
vector of logical matching the input length. Helper functions to construct
these are <code>valRx()</code> and <code>valChoice()</code>. Only fields that
are not identified as NA will be passed to validation functions.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quiet</code></td>
<td>
<p>Print no messages if triggered, Default=FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold</code></td>
<td>
<p>numeric(1). The threshold of non-NA data to trigger casting.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>style</code></td>
<td>
<p>character. One of "labelled" or "coded". Default is "labelled"</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>drop_fields</code></td>
<td>
<p><code>character</code> or <code>NULL</code>. A vector of field names to remove from
the data.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p><code>recastRecords</code> is a post-processing function motivated
initially by the need to switch between codes and labels in multiple
choice fields. Field types for which no casting function is specified will
be returned with no changes. It will not attempt to validate the content
of fields; fields that cannot be successfully cast will be quietly
returned as missing values.
</p>
<p><code>castForImport</code> is written with defaults that will return data
in a format ready to be imported to a project via <code>importRecords</code>.
All fields are returned as character vectors. If any values fail to
validation check, are report is returned as an attribute named <code>invalid</code>.
This attribute may be retrieved using <code>reviewInvalidRecords()</code>.
These are then set to <code>NA</code>, which will be imported as blanks through
the API.
</p>
<p><code>guessCast</code> is a helper function to make a guess at casting uncast
columns. It will do a type cast if a validation is met above
a threshold ratio of non-NA records. It modifies the existing
<code>invalid</code> attribute to reflect the cast.
This attribute may be retrieved using <code>reviewInvalidRecords()</code>.
<code>guessDate</code> is a special cast of <code>guessCast</code> that has defaults set for casting
a date field.
</p>
<p><code>mChoiceCast</code> is a helper function that adds the <code>Hmisc::mChoice</code>
multiple choice class. It adds a column for a multiple choice checkbox
that is cast to the <code>Hmisc::mChoice</code> class. Requires <code>Hmisc</code>
to be loaded.
</p>


<h3>Zero-Coded Check Fields</h3>

<p>A zero-coded check field is a field of the REDCap type <code>checkbox</code> that has
a coding definition of <code style="white-space: pre;">⁠0, [label]⁠</code>. When exported, the field names for
these fields is <code style="white-space: pre;">⁠[field_name]___0⁠</code>. As in other checkbox fields, the
raw data output returns binary values where 0 represent an unchecked
box and 1 represents a checked box. For zero-coded checkboxes, then, a
value of 1 indicates that 0 was selected.
</p>
<p>This coding rarely presents a problem when casting from raw values
(as is done in <code>exportRecordsTyped</code>). However, casting from coded or
labeled values can be problematic. In this case, it becomes
indeterminate from context if the intent of <code>0</code> is 'false' or the coded
value '0' ('true') ...
</p>
<p>The situations in which casting may fail to produce the desired results are</p>

<table>
<tr>
<td style="text-align: left;">
   Code </td>
<td style="text-align: left;"> Label </td>
<td style="text-align: left;"> Result </td>
</tr>
<tr>
<td style="text-align: left;">
   0 </td>
<td style="text-align: left;"> anything other than "0" </td>
<td style="text-align: left;"> Likely to fail when casting from coded values </td>
</tr>
<tr>
<td style="text-align: left;">
   0 </td>
<td style="text-align: left;"> 0 </td>
<td style="text-align: left;"> Likely to fail when casting from coded or labeled values </td>
</tr>
<tr>
<td style="text-align: left;">
</td>
</tr>
</table>
<p>Because of the potential for miscast data, casting functions will issue
a warning anytime a zero-coded check field is encountered. A separate
warning is issued when a field is cast from coded or labeled values.
</p>
<p>When casting from coded or labeled values, it is strongly recommended that
the function <code>castCheckForImport()</code> be used. This function permits the
user to state explicitly which values should be recognized as checked,
avoiding the ambiguity resulting from the coding.
</p>


<h3>See Also</h3>



<h4>Exporting records</h4>

<p><code>exportRecordsTyped()</code>, <br><code>exportReportsTyped()</code>, <br><code>fieldValidationAndCasting()</code>, <br><code>reviewInvalidRecords()</code>
</p>



<h4>Other Post Processing Functions</h4>

<p><code>splitForms()</code>, <br><code>widerRepeated()</code>
</p>



<h4>Vignettes</h4>

<p><code>vignette("redcapAPI-offline-connection", package = "redcapAPI")</code><br><code>vignette("redcapAPI-casting-data")</code><br><code>vignette("redcapAPI-missing-data-detection")</code><br><code style="white-space: pre;">⁠vignette("redcapAPI-data-validation)⁠</code>
</p>



<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
# Using recastRecords after export
Recs &lt;- 
  exportRecordsTyped(rcon) |&gt;
  recastRecords(rcon, 
                fields = "dropdown_test",
                cast = list(dropdown = castCode))
                
                
# Using castForImport
castForImport(Records, 
              rcon)
              
              
# Using castForImport to recast zero-coded checkbox values
castForImport(Records, 
              rcon, 
              cast = list(checkbox = castCheckForImport(c("0", "Unchecked"))))


# Using guessCast
exportRecordsTyped(rcon,
                   validation=skip_validation,
                   cast = raw_cast) |&gt; 
  guessCast(rcon, 
            validation=valRx("^[0-9]{1,4}-(0?[1-9]|1[012])-(0?[1-9]|[12][0-9]|3[01])$"), 
            cast=as.Date,
            threshold=0.6)
            
            
# Using mChoiceCast
exportRecordsTyped(rcon) |&gt; 
  mChoiceCast(rcon)


## End(Not run)


</code></pre>


</div>