<div class="container">

<table style="width: 100%;"><tr>
<td>runMLwiN</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Calls MLwiN from R.</h2>

<h3>Description</h3>

<p>This function executes MLwiN and then brings results back to R.
</p>


<h3>Usage</h3>

<pre><code class="language-R">runMLwiN(
  Formula,
  levID = NULL,
  D = "Normal",
  data = NULL,
  estoptions = list(EstM = 0),
  BUGO = NULL,
  MLwiNPath = NULL,
  stdout = "",
  stderr = "",
  workdir = tempdir(),
  checkversion = TRUE,
  allowcontrast = FALSE,
  indata = NULL,
  saveworksheet = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>Formula</code></td>
<td>
<p>A <code>formula</code> object specifying the model
formula. See <code>Formula.translate</code> (<code>Formula.translate.compat</code>
details back-compatible functionality for deprecated syntax used in
versions of <span class="pkg">R2MLwiN</span> prior to 0.8-0) and also ‘Details’ below.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>levID</code></td>
<td>
<p>A character vector specifying the level ID(s). Deprecated
syntax: by default this is <code>NULL</code> and level ID(s) are specified
in the <code>Formula</code> object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>D</code></td>
<td>
<p>A character string/vector specifying the type of distribution to be modelled, which
can include <code>'Normal'</code> (the default), <code>'Binomial'</code>, <code>'Poisson'</code>,
<code>'Negbinom'</code>, <code>'Unordered Multinomial'</code>, <code>'Ordered Multinomial'</code>,
<code>'Multivariate Normal'</code>, or <code>'Mixed'</code>. In the case of the latter,
<code>'Mixed'</code> precedes the response types which also need to be listed in
<code>D</code>, e.g. <code>c('Mixed', 'Normal', 'Binomial')</code>; these need to be
be listed in the same order to which they are referred to in the
<code>Formula</code> object (see <code>Formula.translate</code>,
<code>Formula.translate.compat</code>). For (R)IGLS estimation (i.e. <code>EstM = 0</code>
in <code>estoptions</code>) <code>'Mixed'</code> combinations can consist of
<code>'Normal'</code> and <code>'Binomial'</code> or <code>'Normal'</code> and <code>'Poisson'</code>;
for MCMC estimation (i.e. <code>EstM = 0</code>), on the other hand, only a combination
of <code>'Normal'</code> and <code>'Binomial'</code> is available.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>A data.frame object containing the data to be modelled.
Optional (but recommended): if empty, data taken from environment of
<code>formula</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>estoptions</code></td>
<td>
<p>A list of options used for estimating the model. See
‘Details’ below.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>BUGO</code></td>
<td>
<p>A vector specifying BUGS options. If non-null, then
WinBUGS/OpenBUGS, in conjunction with MLwiN, are used for modelling. Non-null
only applicable if <code>EstM = 1</code>. See ‘Details’, below.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>MLwiNPath</code></td>
<td>
<p>A path to the MLwiN folder. By default, <code>MLwiNPath = NULL</code>
and path set by <code>options('MLwiN_path')</code>, the default for which can be
changed via <code>options(MLwiN_path = 'path/to/MLwiN vX.XX/')</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>stdout</code></td>
<td>
<p>See <code>system2</code>; <code>''</code> by default (i.e.
output to <code>stdout</code> sent to R console).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>stderr</code></td>
<td>
<p>See <code>system2</code>; <code>''</code> by default (i.e.
output to <code>stderr</code> sent to R console).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>workdir</code></td>
<td>
<p>A path to the folder where the outputted files are to be saved.
If the folder specified does not exist, a new folder of that name is
created; <code>workdir = tempdir()</code> by default.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>checkversion</code></td>
<td>
<p>If <code>TRUE</code> (default), returns version number unless
(a) version detected is unknown or newer than MLwiN version available
when current version of R2MLwiN was released, in which case returns text
to this effect, or (b) version detected &gt; 1 year older than MLwiN version
available when current version of R2MLwiN was released, in which case
function call stopped and user invited to update via usual channels. Can
disable via <code>FALSE</code> e.g. if slowing execution time down (for example
in a simulation).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>allowcontrast</code></td>
<td>
<p>If <code>TRUE</code>, factor variables will follow the R
behaviour when creating contrast variables. If <code>FALSE</code> (default) factor
variables will be converted into a series of zero/one dummies.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>indata</code></td>
<td>
<p>A <code>data.frame</code> object containing the data to be modelled.
Deprecated syntax: by default this is <code>NULL</code> and the <code>data.frame</code>
is instead referenced via <code>data</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>saveworksheet</code></td>
<td>
<p>A file name (or list of file names if more than one chain
is specified) used to store the MLwiN worksheet after the model has been estimated.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>With regard to <code>runMLwiN</code>'s <code>Formula</code> object, see <code>formula</code>
for notes on general usage, noting the following differences:
</p>

<ul>
<li>
<p>The intercept is not included by default (this is keeping with the manner
in which models are specified in MLwiN). To include an intercept, then, one
can specify e.g. <code>normexam ~ 1 + standlrt + (1 | student)</code> or, assuming <code>cons</code>
is a constant of ones, <code>normexam ~ cons + standlrt + (cons | student)</code>. (Note also,
as further detailed below, for normal response models the level 1 ID (<code>student</code> in this example)
needs to be explicitly included in the random part of the model formula; this is not the
case for discrete response models.
</p>
</li>
<li>
<p>The link function and denominator are included in the <code>Formula</code> object, e.g.
fitting a logistic model in which the variable <code>denom</code> is specified as the denominator:
<code>logit(resp, denom) ~ 1 + age + (1 | region)</code>.
</p>
</li>
</ul>
<p>Further details are as follows.
</p>
<p>The random part of the model is specified in sets of parentheses arranged in
descending order with respect to their hierarchy. E.g. in the case of a 3-level
model, the variable containing the level 3 ID is specified first, then
the variable containing the level 2 ID, etc. Note that the variable containing
the level 1 ID also needs to be explicitly specified unless
it is a discrete response model (in which case you should not specify it).
</p>
<p>The table below summarises the options for the <code>Formula</code> argument in
<span class="pkg">R2MLwiN</span>. They assume an intercept is added (via <code>~ 1</code>; for alternative
specifications see <code>formula</code>). <code>&lt;link&gt;</code> denotes the link function,
<code>&lt;y1&gt;</code>, <code>&lt;y2&gt;</code>, etc. represent response variables, <code>&lt;denom&gt;</code> denotes
the denominator, <code>&lt;offs&gt;</code> the offset (optional), <code>&lt;L2&gt;</code>, <code>&lt;L1&gt;</code>, etc. the
variables containing the level 2 and level 1 identifying codes, and <code>&lt;ref_cat&gt;</code>
represents the reference category of a categorical response variable (optional:
if unspecified the lowest level of the factor is used as the reference category).
Explanatory variables are specified as e.g. <code>&lt;x1&gt; + &lt;x2&gt;</code>. For <code>'Ordered Multinomial'</code>,
<code>'Multivariate Normal'</code> and <code>'Mixed'</code> responses, <code>[&lt;common&gt;]</code> indicates
a common coefficient (i.e. the same for each category) is to be fitted; here <code>&lt;common&gt;</code>
takes the form of a numeric identifier indicating the responses for which a common
coefficient is to be added (e.g. <code>[1:5]</code> to fit a common coefficient for
categories <code>1</code> to <code>5</code> of a 6-point ordered variable, <code>[1]</code> to fit a common
coefficient for the response variable specified first in the <code>Formula</code> object
for a <code>'Mixed'</code> response model, etc.) Otherwise a separate coefficient
(i.e. one for each category) is added. For <code>'Mixed'</code> response models, the
<code>Formula</code> arguments need to be grouped in the order the distributions
are listed in <code>D</code>.
</p>
<p>* denotes IGLS only in the table below.
</p>

<table>
<tr>
<td style="text-align: left;">
<strong>Distribution</strong> </td>
<td style="text-align: left;"> <strong>Format of <code>Formula</code> object</strong> </td>
<td style="text-align: left;"> <strong>Where <code>&lt;link&gt;</code> can equal...</strong>
</td>
</tr>
<tr>
<td style="text-align: left;">
<code>'Normal'</code> </td>
<td style="text-align: left;"> <code>&lt;y1&gt; ~ 1 + &lt;x1&gt; + (1|&lt;L2&gt;) + (1|&lt;L1&gt;) + ...</code> </td>
<td style="text-align: left;"> (identity link assumed)</td>
</tr>
<tr>
<td style="text-align: left;">
<code>'Poisson'</code> </td>
<td style="text-align: left;"> <code>&lt;link&gt;(&lt;y1&gt;) ~ 1 + offset(&lt;offs&gt;) + &lt;x1&gt; + (1|&lt;L2&gt;) + ...</code> </td>
<td style="text-align: left;"> <code>log</code>
</td>
</tr>
<tr>
<td style="text-align: left;">
<code>'Negbinom'</code> </td>
<td style="text-align: left;"> <code>&lt;link&gt;(&lt;y1&gt;) ~ 1 + offset(&lt;offs&gt;) + (1|&lt;L2&gt;) + ...</code> </td>
<td style="text-align: left;"> <code>log</code>
</td>
</tr>
<tr>
<td style="text-align: left;">
<code>'Binomial'</code> </td>
<td style="text-align: left;"> <code>&lt;link&gt;(&lt;y1&gt;, &lt;denom&gt;) ~ 1 + &lt;x1&gt; + (1|&lt;L2&gt;) + ...</code> </td>
<td style="text-align: left;"> <code>logit</code>,<code>probit</code>,<code>cloglog</code>
</td>
</tr>
<tr>
<td style="text-align: left;">
<code>'Unordered Multinomial'</code> </td>
<td style="text-align: left;"> <code>&lt;link&gt;(&lt;y1&gt;, &lt;denom&gt;, &lt;ref_cat&gt;) ~ 1 + &lt;x1&gt; + (1|&lt;L2&gt;) + ...</code> </td>
<td style="text-align: left;"> <code>logit</code>
</td>
</tr>
<tr>
<td style="text-align: left;">
<code>'Ordered Multinomial'</code> </td>
<td style="text-align: left;"> <code>&lt;link&gt;(&lt;y1&gt;, &lt;denom&gt;, &lt;ref_cat&gt;) ~ 1 + &lt;x1&gt; + &lt;x2&gt;[&lt;common&gt;] + (1[&lt;common&gt;]|&lt;L3&gt;) + (1|&lt;L2&gt;) + ...</code> </td>
<td style="text-align: left;"> <code>logit</code>,<code>probit</code>,<code>cloglog</code>
</td>
</tr>
<tr>
<td style="text-align: left;">
<code>'Multivariate Normal'</code> </td>
<td style="text-align: left;"> <code>c(&lt;y1&gt;, &lt;y2&gt;, ...) ~ 1 + &lt;x1&gt; + &lt;x2&gt;[&lt;common&gt;] + (1[&lt;common&gt;]|&lt;L3&gt;) + (1|&lt;L2&gt;) + (1|&lt;L1&gt;) + ...</code> </td>
<td style="text-align: left;"> (identity link assumed)</td>
</tr>
<tr>
<td style="text-align: left;">
<code>c('Mixed', 'Normal', 'Binomial')</code> </td>
<td style="text-align: left;"> <code>c(&lt;y1&gt;, ..., &lt;link&gt; (&lt;y2&gt;, &lt;denom&gt;), ...) ~ 1 + &lt;x1&gt; + &lt;x2&gt;[&lt;common&gt;] + (1[&lt;common&gt;]|&lt;L3&gt;) + (1|&lt;L2&gt;) + (1|&lt;L1&gt;) + ...</code> </td>
<td style="text-align: left;"> <code>logit</code>*,<code>probit</code>,<code>cloglog</code>*</td>
</tr>
<tr>
<td style="text-align: left;">
<code>c('Mixed', 'Normal', 'Poisson')</code>* </td>
<td style="text-align: left;"> <code>c(&lt;y1&gt;, ..., &lt;link&gt;(&lt;y2&gt;, &lt;offset&gt;), ...) ~ 1 + &lt;x1&gt; + &lt;x2&gt;[&lt;common&gt;] + (1[&lt;common&gt;]|&lt;L3&gt;) + (1|&lt;L2&gt;) + (1|&lt;L1&gt;) + ...</code> </td>
<td style="text-align: left;"> <code>log</code>
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
</tr>
</table>
<p>The argument <code>estoptions</code> is a list which can contain the
following options used for estimating the model:
</p>

<ul>
<li> <p><code>EstM</code>: specifies estimation method. When <code>EstM = 0</code> (default), estimation
method is (R)IGLS, otherwise <code>EstM = 1</code> specifies MCMC estimation.
</p>
</li>
<li> <p><code>resi.store</code>: a logical value indicating whether residuals are to be
stored or not. Defaults to <code>FALSE</code>.
</p>
</li>
<li> <p><code>resioptions</code>: a string vector to specify the various residual options.
The <code>'variance'</code> option calculates the posterior variances instead of
the posterior standard errors; the <code>'standardised'</code>, <code>'leverage'</code>, <code>'influence'</code>
and <code>'deletion'</code> options calculate standardised,
leverage, influence and deletion residuals respectively; the
<code>'sampling'</code> option calculates the sampling variance covariance matrix
for the residuals; the <code>'norecode'</code> option prevents residuals with values exceedingly close or
equal to zero from being recoded to missing.
When <code>EstM = 1</code> (i.e. MCMC estimation) <code>'variance'</code>
is default value, and the only other permissible value is <code>'standardised'</code>
(else function call stopped with appropriate error message).
When <code>EstM = 0</code> (i.e. (R)IGLS estimation), <code>'variance'</code>
cannot be specified together with <code>'standardised'</code>, <code>'leverage'</code> or
<code>'deletion'</code> (function call stopped with appropriate error message).
Default is <code>resioptions = c('variance')</code>.
</p>
</li>
<li> <p><code>resi.store.levs</code>: an integer vector indicating the levels at which the
residual chains are to be stored (<code>NULL</code> by default). Non-<code>NULL</code> values
not valid when <code>EstM = 0</code> (i.e. (R)IGLS estimation), else if <code>EstM = 0</code>
and <code>resi.store.levs</code> non-<code>NULL</code>, residual chains at specified levels
are returned.
</p>
</li>
<li> <p><code>debugmode</code>: a logical value determining whether MLwiN is run in the
background or not. The default value is <code>FALSE</code>: i.e. MLwiN is run in
the background. If <code>TRUE</code> the MLwiN GUI is opened, and then pauses after the model
has been set-up, allowing user to check starting values; pressing 'Resume macro'
will then fit the model. Once fit, pressing 'Resume macro' once more will save
the outputs to the <code>workdir</code> ready to be read by <span class="pkg">R2MLwiN</span>. Users can
instead opt to 'Abort macro' in which case the outputs are not saved to the
<code>workdir</code>. This option currently
works for 32 bit version of MLwiN only (automatically switches unless
<code>MLwiNPath</code> or <code>options(MLwiNPath)</code>
has been set directly to the executable).
</p>
</li>
<li> <p><code>x64</code>: a logical value indicating
whether the 64 bit version of MLwiN is used (unless <code>MLwiNPath</code> or <code>options(MLwiNPath)</code>
has been set directly to the executable). The default is determined by the characteristics
of the operating system on which the script is executed. If <code>FALSE</code>,
the 32 bit version is called, if <code>TRUE</code> 64 bit version is called.
</p>
</li>
<li> <p><code>clean.files</code>: specifies whether the generated files are removed from
the <code>workdir</code> (<code>TRUE</code>, the default) or not (<code>FALSE</code>).
</p>
</li>
<li> <p><code>show.file</code>: a logical value indicating whether the output files (e.g.
MLwiN macro file) are shown on the screen. Defaults to <code>FALSE</code>.
</p>
</li>
<li> <p><code>clre</code>: a matrix used to define which elements of the random effects matrix
to remove (i.e. hold constant at zero). Removes
from the random part at level &lt;first row&gt; the covariance matrix element(s)
defined by the pair(s) of rows &lt;second row&gt; &lt;third row&gt;. Each column
corresponds to a removed entry of the covariance matrix. See e.g. <code>demo(UserGuide07)</code>
for an example.
</p>
</li>
<li> <p><code>notation</code>: specifies the model subscript notation
to be used in the MLwiN equations window. <code>'class'</code> means no multiple
subscripts, whereas <code>'level'</code> has multiple subscripts. If
<code>notation = NULL</code>, defaults to <code>'level'</code> if <code>'xc = NULL'</code> else
defaults to <code>'class'</code>.
</p>
</li>
<li> <p><code>mem.init</code>: sets and displays worksheet capacities for
the current MLwiN session. A vector of length 5 corresponding to
the following order: number of levels (defaults to 1 + the number of
levels specified in the function call); worksheet size in thousands of cells
(default is 6000); the number of columns (default is 2500); the number of
explanatory variables (default it 10 + number of explanatory variables
calculated initially); the number of group labels (default is 20).
</p>
</li>
<li> <p><code>optimat</code>: instructs MLwiN to limit the maximum matrix size
that can be allocated by the (R)IGLS algorithm. Specify <code>optimat = TRUE</code>
if MLwiN gives the following error message 'Overflow allocating smatrix'.
This error message arises if one or more higher-level units is/are extremely
large (containing more than 800 lower-level units). In this situation <code>runMLwiN</code>'s
default behaviour is to instruct MLwiN to allocate a larger matrix size to
the (R)IGLS algorithm than is currently possible. Specifying
<code>optimat = TRUE</code> caps the maximum matrix size at 800 lower-level units,
circumventing the MLwiN error message, and allowing most MLwiN
functionality.
</p>
</li>
<li> <p><code>nonlinear</code>: a character vector specifying linearisation method for discrete
response models estimated via IGLS (see Chapter 9 of Rasbash et al 2012,
and Goldstein 2011). <code>N = 0</code> specifies marginal quasi-likelihood
linearization (MQL), whilst <code>N = 1</code> specifies penalised quasi-
likelihood linearization (PQL); <code>M = 1</code> specifies first order
approximation, whilst <code>M = 2</code> specifies second order approximation.
<code>nonlinear = c(N = 0, M = 1)</code> by default. First order marginal
quasi-likelihood (MQL1) only option for single-level discrete response
models. Pertains to discrete response models estimated via IGLS: i.e. when
<code>EstM = 0</code> in <code>estoptions</code>, and for starting values when estimated via IGLS
for MCMC (<code>EstM = 1</code>).
</p>
</li>
<li> <p><code>Meth</code>: specifies which maximum likelihood estimation method is to be
used. If <code>Meth = 0</code> estimation method is set to RIGLS. If <code>Meth = 1</code>
estimation method is set to IGLS (the default setting).  Pertains to models
estimated via (R)IGLS: i.e. when <code>EstM = 0</code> in <code>estoptions</code>, and for starting
values when estimated via (R)IGLS for MCMC (<code>EstM = 1</code>).
</p>
</li>
<li> <p><code>merr</code>: a vector which sets-up measurement errors on predictor
variables. The first element <code>N</code> defines the number of variables that
have measurement errors. Then, for each variable with measurement error, a
pair of inputs are required: the first of these is the explanatory variable
name as a character string, and the second is the variance of
the measurement error for this variable. See <code>demo(MCMCGuide14)</code> for an
example.
</p>
</li>
<li> <p><code>fact</code>: a list of objects specified for factor analysis,
including:
</p>

<ul>
<li> <p><code>nfact</code>: Specifies the number of factors
</p>
</li>
<li> <p><code>lev.fact</code>: Specifies the level/classification for the random part of
the factor for each factor.
</p>
</li>
<li> <p><code>nfactcor</code>: Specifies the number of
correlated factors
</p>
</li>
<li> <p><code>factcor</code>: A vector specifying the correlated
factors: the first element corresponds to the first factor number, the
second to the second factor number, the third element corresponds to the
starting value for the covariance and the fourth element to whether this
covariance is constrained
(<code>1</code>) or not (<code>0</code>). If more than one pair of factors is correlated,
then repeat this sequence for each pair.
</p>
</li>
<li> <p><code>loading</code>: A matrix specifying the
starting values for the factor loadings and the starting value of the factor
variance. Each row corresponds to a factor.
</p>
</li>
<li> <p><code>constr</code>: A matrix
specifying indicators of whether the factor loadings and the factor variance
are constrained (<code>1</code>) or not (<code>0</code>).
</p>
</li>
</ul>
</li>
<li> <p><code>weighting</code>: a deprecated option for specifying weights in IGLS estimation:
see <code>fpsandwich</code> and <code>rpsandwich</code> for new method of doing so.
<code>weighting</code> is a list of objects including <code>levels</code>, <code>weights</code>,
<code>mode</code>, <code>FSDE</code> and <code>RSDE</code>; see <code>write.IGLS</code> for details.
</p>
</li>
<li> <p><code>centring</code>: deprecated method (only applicable when using old syntax
pre-<span class="pkg">R2MLwiN</span> v.0.8-0) specifying function by
which explanatory variables are to be centred (users can instead transform
variables prior to <code>runMLwiN</code> call).
If non-<code>NULL</code>, centring is used for the selected explanatory
variables (<code>centring = NULL</code> by default). <code>centring</code> is a list of
objects specifying the methods to be used to centre specific explanatory
variables. E.g. <code>list(age = 1, ...)</code> specifies that the explanatory
variable <code>age</code> is to be centred around its grand mean;
<code>list(age = c(2, 'district'), ...)</code> specifies that <code>age</code> is to be
centred around its group mean, where group defined by the variable <code>district</code>;
and <code>list(age = c(3, 18), ...)</code> specifies that <code>age</code> is to
be centred around the value <code>18</code>.
</p>
</li>
<li> <p><code>xclass</code>: a deprecated option for specifying cross-classified and/or
multiple membership models; see <code>xc</code> and <code>mm</code> for new method of
doing so. <code>xclass</code> is a list of objects including <code>class</code>,
<code>N1</code>, <code>weight</code>, <code>id</code> and <code>car</code>; see <code>write.MCMC</code> for details.
</p>
</li>
<li> <p><code>mcmcOptions</code>: a list of objects specifying MCMC options, including the
following:
</p>

<ul>
<li> <p><code>orth</code>: If <code>orth = 1</code>, orthogonal fixed effect
vectors are used; zero otherwise.
</p>
</li>
<li> <p><code>hcen</code>: An integer specifying the
level where we use hierarchical centering.
</p>
</li>
<li> <p><code>smcm</code>: If <code>smcm = 1</code>,
structured MCMC is used; zero otherwise.
</p>
</li>
<li> <p><code>smvn</code>: If <code>smvn = 1</code>, the
structured MVN framework is used; zero otherwise.
</p>
</li>
<li> <p><code>paex</code>: A matrix of Nx2; in each row, if the second digit is <code>1</code>, parameter expansion
is used at level &lt;the first digit&gt;.
</p>
</li>
<li> <p><code>mcco</code>: This
command allows the user to have constrained settings for the lowest level
variance matrix in a multivariate Normal model. If value is <code>0</code>,
it estimates distinct variances for each residual error and distinct covariances
for each residual error pair. Four other
settings are currently available:<br></p>

<table>
<tr>
<td style="text-align: left;">
<code>1</code> </td>
<td style="text-align: left;"> fits stuctured errors with a common correlation paramater and a common variance parameter;</td>
</tr>
<tr>
<td style="text-align: left;">
<code>2</code> </td>
<td style="text-align: left;"> fits AR1 errors with a common variance parameter;</td>
</tr>
<tr>
<td style="text-align: left;"> <code>3</code> </td>
<td style="text-align: left;"> fits structured errors with a common
correlation parameter and independent variance parameters;</td>
</tr>
<tr>
<td style="text-align: left;"> <code>4</code> </td>
<td style="text-align: left;"> fits AR1 errors with independent variance
parameters.</td>
</tr>
<tr>
<td style="text-align: left;"> </td>
</tr>
</table>
</li>
</ul>
</li>
<li> <p><code>drop.data</code>: If <code>TRUE</code> (default) only the data involved in the model
is passed to MLwiN, otherwise the entire dataset in <code>data</code> is passed.
</p>
</li>
<li> <p><code>drop.levels</code>: If <code>TRUE</code> (default) any unused levels are dropped from factors, otherwise the dataset
is left unchanged.
</p>
</li>
<li> <p><code>fpsandwich</code>: specifies standard error type for fixed parameters. If
<code>fpsandwich = TRUE</code>, robust or ‘sandwich’ standard errors based on raw
residuals are used, if <code>fpsandwich = FALSE</code> (default) then standard,
uncorrected, IGLS or RIGLS computation used.
</p>
</li>
<li> <p><code>rpsandwich</code>: specifies standard error type for random parameters. If
<code>rpsandwich = TRUE</code>, robust or ‘sandwich’ standard errors based on raw
residuals are used, if <code>rpsandwich = FALSE</code> (default) then standard,
uncorrected, IGLS or RIGLS ‘plug in’ estimates used.
</p>
</li>
<li> <p><code>smat</code>: a matrix with two rows the levels at which a diagonal
matrix is to be specified. The first row specifies the level.
If the value of the second row is <code>1</code> then the random covariance matrix is
set to be diagonal.
</p>
</li>
<li> <p><code>maxiter</code>: a numeric value specifying the maximum number of iterations, from
the start, before (R)IGLS estimation halts. Pertains to models
estimated via (R)IGLS: i.e. when <code>EstM = 0</code> in <code>estoptions</code>, and for starting
values when estimated via (R)IGLS for MCMC (<code>EstM = 1</code>).
</p>
</li>
<li> <p><code>tol</code>: a numeric value specifying the convergence criterion.
If value is m, estimation will be
deemed to have converged when the relative change in the estimate for all
parameters from one iteration to the next is less than 10(-m). Defaults to
value of <code>2</code> for m if not otherwise specified.  Pertains to models
estimated via (R)IGLS: i.e. when <code>EstM = 0</code> in <code>estoptions</code>, and for starting
values when estimated via (R)IGLS for MCMC (<code>EstM = 1</code>).
</p>
</li>
<li> <p><code>extra</code>: if <code>TRUE</code>, extra binomial, extra negative binomial,
extra Poisson or extra multinomial distributions assumed, else <code>FALSE</code>.
can only be specified for discrete response models (i.e. <code>'Binomial'</code>,
<code>'Negbinom'</code>, <code>'Poisson'</code>, <code>'Multinomial'</code>)
estimated via (R)IGLS (i.e. <code>EstM = 0</code>).
</p>
</li>
<li> <p><code>reset</code>: a vector specifying the action to be
taken, at each level, if a variance parameter is estimated at a particular
iteration to be negative during estimation. Values specified in
ascending order of level hierarchy: if <code>0</code> a negative variance
estimate is reset to zero and so are any associated covariances; if <code>1</code>
a negative variance estimate is reset to zero but not the associated
covariances; if <code>2</code> no resetting takes place. E.g. <code>reset = c(0, 1)</code>
to assign value <code>0</code> to level 1 and value <code>1</code> to level 2 of
two-level model.
</p>
</li>
<li> <p><code>constraints</code>: <code>fixed.ui</code> and <code>fixed.ci</code> are used
to specify constraints on the fixed coefficients, and <code>random.ui</code>
and <code>random.ci</code> to specify constraints on the random parameters. The
syntax for specifying just fixed parameter constraints is
<code>constraints = list(fixed.ui = &lt;fixed matrix&gt;, fixed.ci = &lt;fixed values&gt;)</code>,
where <code>&lt;fixed matrix&gt;</code> is a matrix where each row represents one fixed part
parameter, in the same order that they appear in the results table, each
column represents one constraint, and the values in the matrix are multipliers
for the parameters; and <code>&lt;fixed values&gt;</code> is a vector of values, one per
constraint, to which the parameters multiplied by the multipliers in the
corresponding column of <code>&lt;fixed matrix&gt;</code> should be equal. For example,
if we have a model with formula <code>y ~ 1 + x1 + x2 + x3 + x4 + (1|lev1ID)</code>,
then <code>constraints = list(fixed.ui = matrix(c(0, 1, -1, 0, 0, 0, 0, 0, 1, 2), nrow = 5),
fixed.ci = c(0, 2))</code> specifies the constraints that the coefficient of <code>x1</code>
equals the coefficient of <code>x2</code> and that the coefficient of <code>x3</code> plus
twice the coefficient of <code>x4</code> equals <code>2</code>. Random constraints are
specified similarly, and fixed and random constraints may be applied
simultaneously. Applies to <code>EstM = 0</code> (i.e. estimation via (R)IGLS) only.
</p>
</li>
<li> <p><code>xc</code>: indicates whether model is cross-classified (<code>TRUE</code>) or
nested (<code>FALSE</code>). Ignored if <code>EstM = 0</code>, i.e. only applicable to
models estimated via MCMC. Defaults to <code>xc = FALSE</code>, unless either
<code>mm</code> or <code>car</code> are non-<code>NULL</code>, in which case <code>xc = TRUE</code>. Supersedes
deprecated <code>xclass</code>.
</p>
</li>
<li> <p><code>mm</code>: specifies the structure of a multiple membership model.
Can be a list of variable names, a list of vectors, or a matrix (e.g. see
<code>df2matrix</code>). In the case of the former, each
element of the list corresponds to a level (classification) of the model,
in descending order. If a level is not a multiple membership classification,
then <code>NA</code> is specified. Otherwise, lists need to be assigned to
<code>mmvar</code> and <code>weights</code>, with the former containing columns
specifying the classification units, and the latter containing columns
specifying the weights. Ignored if <code>EstM = 0</code>, i.e. only applicable to models estimated via
MCMC. <code>mm = NULL</code> by default. Supersedes deprecated <code>xclass</code>.
E.g. (from <code>demo(MCMCGuide16)</code>) for
<code>logearn ~ 1 + age_40 + sex + parttime + (1 | company) + (1 | id)</code>, if
<code>company</code> is a multiple membership classification with the variables
indicating the classifications in <code>company</code>, <code>company2</code>,
<code>company3</code>, <code>company4</code> and their weights in <code>weight1</code>, <code>weight2</code>,
<code>weight3</code> and <code>weight4</code> then
<code>mm = list(list(mmvar = list('company', 'company2', 'company3', 'company4'),</code>
<code>weights = list('weight1', 'weight2', 'weight3', 'weight4')), NA)</code>
with the <code>NA</code>, listed last, corresponding to the level 1 identifier (<code>id</code>).
</p>
</li>
<li> <p><code>car</code>: specifies the structure of a conditional autoregressive (CAR)
model. Can be a list of variable names, a list of vectors, or a matrix (e.g. see
<code>df2matrix</code>). In the case of the former, each element of the list
corresponds to a level (classification) of
the model, in descending order. If a level is not a spatial classification,
then <code>NA</code> is specified. Otherwise, lists need to be assigned to
<code>carvar</code> and <code>weights</code>, with the former containing columns
specifying the spatial classification units, and the latter containing
columns specifying the weights. See <code>demo(MCMCGuide17)</code> for examples.
Ignored if <code>EstM = 0</code>, i.e. only applicable
to models estimated via MCMC. <code>car = NULL</code> by default. Supersedes
deprecated <code>xclass</code>. See <code>demo(MCMCGuide17)</code> for examples.
</p>
</li>
<li> <p><code>carcentre</code>: if CAR model (i.e. if <code>car</code> is non-<code>NULL</code>),
<code>carcentre = TRUE</code> mean-centres all random effects at that level.
</p>
</li>
<li> <p><code>startval</code>: a list of numeric vectors specifying the starting values.
If multiple chains requested (via <code>nchains</code>), then can be a list of such lists.
<code>FP.b</code> corresponds to the estimates for the fixed
part; <code>FP.v</code> specifies the variance/covariance estimates for the fixed
part; <code>RP.b</code> specifies the variance estimates for the random part;
<code>RP.v</code> corresponds to the variance/covariance matrix of the variance
estimates for the random part. <code>startval = NULL</code> by default: i.e. when
<code>EstM = 0</code> the OLS estimates are used, else if <code>EstM = 1</code> the
estimates obtained from IGLS are used as the starting values for MCMC.
</p>
</li>
<li> <p><code>sort.force</code>: If <code>TRUE</code> will sort data based on hierarchy as
determined by model formula; defaults to <code>FALSE</code>.
</p>
</li>
<li> <p><code>sort.ignore</code>: If <code>FALSE</code> will check data is sorted in a manner in
keeping with the hierarchy implied by the model formula, and will return a warning
if that is not the case.
</p>
</li>
<li> <p><code>rng.version</code>: An integer value specifing the random number generator
version to be used by MLwiN. If 10 (the default) this will be the Mersenne Twister; 
If 0 this will be the 3-Seed Wichmann-Hill (default in MLwiN prior to version 3).
</p>
</li>
<li> <p><code>mcmcMeth</code>: list of objects specifying MCMC methodology and prior
options, including the following (see <code>write.MCMC</code> for further details):
</p>

<ul>
<li> <p><code>iterations</code>: Number of main iterations post-burnin (i.e. monitoring chain length), defaults to 5000.
</p>
</li>
<li> <p><code>burnin</code>: Length of burnin, defaults to 500.
</p>
</li>
<li> <p><code>nchains</code>: Number of MCMC chains to run, defaults to 1.
</p>
</li>
<li> <p><code>thinning</code>: Thinning factor, defaults to 1.
</p>
</li>
<li> <p><code>seed</code>: MCMC random number seed, defaults to <code>1</code> when <code>nchains = 1</code>,
and to <code>1:nchains</code> when multiple chains requested.
</p>
</li>
<li> <p><code>priorParam</code>: A list specifying informative priors. This includes:
<code>fixe</code> – for the fixed
parameters, if proper normal priors are used for some parameters, a list of
vectors of length two is provided, each of which specifies the mean and the
standard deviation. If not given, default ('flat' or 'diffuse') priors are
used for the parameters; <code>fixe.common</code> – for multivariate normal,
multinomial and mixed response models, if common coefficients are added, use
<code>fixe.common</code> rather than <code>fixe</code>; <code>fixe.sep</code> – if the common
coefficients are added, use <code>fixe.sep</code> for the separate coefficients;
<code>rp1</code> – a list object specifying the Wishart or gamma prior for the
covariance matrix or scalar variance at level 1 (this consists of: (1)
<code>estimate</code> – a prior guess for the true value of the covariance matrix;
(2) <code>size</code> – sample size for guess.
Note that this is a weakly-informative prior and the default prior
is used if missing); <code>rp2</code> – a list object specifying the Wishart or
gamma prior for the covariance matrix or scalar variance at level 2 (this
consists of: (1) <code>estimate</code> – an estimate for the true value of the
inverse of the covariance matrix; (2) <code>size</code> – the number of rows in
the covariance matrix. Note that this is a weakly-informative prior and the
default prior is used if missing).
</p>
</li>
<li> <p><code>scale</code>: Scale factor for proposal variances: this number will be
multiplied by the estimated parameter variance (from IGLS/RIGLS) to give the
proposal distribution variance. Defaults to 5.8.
</p>
</li>
<li> <p><code>refresh</code>: Number of iterations after which screen (in MLwiN GUI) is
to be refreshed. Defaults to 50.
</p>
</li>
<li> <p><code>fixM</code>: Specifies the estimation method for the fixed effects:
<code>1</code> for Gibbs sampling, <code>2</code> for univariate Metropolis-Hastings (MH)
sampling and <code>3</code> for multivariate MH sampling. Defaults to <code>2</code> if
Poisson, Multinomial, Binomial or Mixed model, else defaults to <code>1</code>.
</p>
</li>
<li> <p><code>residM</code>: Specifies the estimation method for the random effects
(residuals): <code>1</code> for Gibbs sampling, <code>2</code> for univariate
Metropolis-Hastings (MH) sampling and <code>3</code> for multivariate MH sampling.
Defaults to <code>2</code> if Poisson, Multinomial, Binomial or Mixed model,
else defaults to <code>1</code>.
</p>
</li>
<li> <p><code>Lev1VarM</code>: Specifies the estimation method for the level 1 variance:
<code>1</code> for Gibbs sampling, <code>2</code> for univariate
Metropolis-Hastings (MH) sampling and <code>3</code> for multivariate MH sampling.
Defaults to <code>2</code> if Poisson, Multinomial, Binomial or Mixed model,
else defaults to <code>1</code>.
</p>
</li>
<li> <p><code>OtherVarM</code>: Specifies the estimation method for the higher level
variance matrices: <code>1</code> for Gibbs sampling, <code>2</code> for univariate
Metropolis-Hastings (MH) sampling and <code>3</code> for multivariate MH sampling.
Defaults to <code>1</code>.
</p>
</li>
<li> <p><code>adaption</code>: <code>adaption = 1</code> (the default) indicates adaptation is to be used,
<code>adaption = 0</code> indicates it is not.
</p>
</li>
<li> <p><code>tol</code>: An integer specifying tolerance (as a percentage; defaults to 10) when
<code>adaption = 1</code> (ignored if <code>adaption = 0</code>).
</p>
</li>
<li> <p><code>rate</code>: An integer specifying the acceptance rate (as a percentage; defaults
to 50) when <code>adaption = 1</code> (ignored if <code>adaption = 0</code>).
</p>
</li>
<li> <p><code>priorcode</code>: A vector indicating which default priors are to be used
for the variance parameters. It defaults to <code>c(gamma = 1)</code> in which case
Gamma priors are used with MLwiN's defaults of Gamma a value (shape) = 0.001
and Gamma b value (scale) = 0.001, although alternative values for shape and
scale can be specified in subsequent elements of the vector,
e.g. <code>c(gamma = 1, shape = 0.5, scale = 0.2)</code>). Alternatively
<code>c(uniform = 1)</code> specifies Uniform priors on the variance scale. To allow
for back-compatibility with deprecated syntax used in versions of
<span class="pkg">R2MLwiN</span> prior to 0.8-2, if <code>priorcode</code> is instead specified as
an integer, then <code>1</code> indicates that Gamma priors are used, whereas
<code>0</code> indicates that Uniform priors are used. See the section on 'Priors' in the
MLwiN help system for more details on the meaning of these priors.
</p>
</li>
<li> <p><code>startval</code>: Deprecated: starting values are now specified directly
within <code>estoptions</code>.
</p>
</li>
<li> <p><code>lclo</code>: Toggles on/off the possible forms of complex level
1 variation when using MCMC. By default (<code>lclo = 0</code>) the level
1 variation is expressed as a function of the predictors. Else
(<code>lclo = 1</code>) the log of the level 1 precision (1/variance) is expressed as
a function of the predictors. Defaults to <code>lclo = 0</code>.
</p>
</li>
<li> <p><code>dami</code>: Outputs a complete (i.e. including non-missing
responses) response variable y. If <code>dami = c(0, &lt;iter1&gt;, &lt;iter2&gt;, ...)</code> then
the response variables returned will be the value of y at the iterations
quoted (as integers <code>&lt;iter1&gt;, &lt;iter2&gt;</code>, etc.); these can be used for
multiple imputation. If <code>dami = 1</code> the value of y will be the mean
estimate from the iterations produced. <code>dami = 2</code> is as for <code>dami = 1</code>
but with the standard errors of the estimate additionally being stored.
<code>dami = NULL</code> by default.
</p>
</li>
</ul>
</li>
</ul>
<p>The argument <code>BUGO</code> is a vector specifying BUGS options as follows:
</p>

<ul>
<li> <p><code>n.chains</code>: specifies the
number of chains used by BUGS.
</p>
</li>
<li> <p><code>debug</code>: determines
whether BUGS stays open following completion of the model run;
<code>debug = FALSE</code> by default.
</p>
</li>
<li> <p><code>seed</code>: sets the random number
generator in BUGS.
</p>
</li>
<li> <p><code>bugs.directory</code>: specifies the path where WinBUGS
has been installed (not required if <code>OpenBugs = TRUE</code>).
</p>
</li>
<li> <p><code>OpenBugs</code>: if <code>OpenBugs = TRUE</code>, OpenBUGS is used.
Otherwise (i.e. <code>OpenBugs = FALSE</code>, the default) WinBUGS is used.
</p>
</li>
</ul>
<h3>Value</h3>

<p>If <code>BUGO</code> is non-NULL then the output is an <code>mcmc.list</code>
object.
</p>
<p>If the IGLS algorithm is used (i.e., <code>EstM = 0</code>), then returns <code>mlwinfitIGLS-class</code> object;
if MCMC estimation used (i.e., <code>EstM = 1</code>), then returns <code>mlwinfitMCMC-class</code> object.
</p>


<h3>Author(s)</h3>

<p>Zhang, Z., Charlton, C.M.J., Parker, R.M.A., Leckie, G., and Browne,
W.J. (2016) Centre for Multilevel Modelling, University of Bristol.
</p>


<h3>References</h3>

<p>Goldstein, H. (2011) Multilevel Statistical Models. 4th Edition. London: John Wiley and Sons.
</p>
<p>Rasbash, J., Steele, F., Browne, W.J. and Goldstein, H. (2012)
A User's Guide to MLwiN Version 2.26. Centre for Multilevel Modelling,
University of Bristol.
</p>


<h3>See Also</h3>

<p><code>formula</code>, <code>Formula.translate</code>, <code>Formula.translate.compat</code>, <code>write.IGLS</code>, <code>write.MCMC</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
## The R2MLwiN package includes scripts to replicate all the analyses in
## Rasbash et al (2012) A User's Guide to MLwiN Version 2.26 and
## Browne, W.J. (2012) MCMC estimation in MLwiN Version 2.26.
## The MLwiN manuals are available online, see:
## http://www.bristol.ac.uk/cmm/software/mlwin/download/manuals.html

## Not run: 
library(R2MLwiN)
# NOTE: if MLwiN not saved in location R2MLwiN defaults to, specify path via:
# options(MLwiN_path = 'path/to/MLwiN vX.XX/')
# If using R2MLwiN via WINE, the path may look like this:
# options(MLwiN_path = '/home/USERNAME/.wine/drive_c/Program Files (x86)/MLwiN vX.XX/')

## For a list of demo titles
demo(package = 'R2MLwiN')

## Take MCMCGuide03 as an example
## To view file
file.show(system.file('demo', 'MCMCGuide03.R', package='R2MLwiN'))

## To run the demo
demo(MCMCGuide03)

## End(Not run)

</code></pre>


</div>