<div class="container">

<table style="width: 100%;"><tr>
<td>rdplotdensity</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Density Plotting for Manipulation Testing</h2>

<h3>Description</h3>

<p><code>rdplotdensity</code> constructs density plots. It is based on the
local polynomial density estimator proposed in Cattaneo, Jansson and Ma (2020, 2023).
A companion <code>Stata</code> package is described in Cattaneo, Jansson and Ma (2018).
</p>
<p>Companion command: <code>rddensity</code> for manipulation (density discontinuity) testing.
</p>
<p>Related Stata and R packages useful for inference in regression discontinuity (RD)
designs are described in the website: <a href="https://rdpackages.github.io/">https://rdpackages.github.io/</a>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">rdplotdensity(
  rdd,
  X,
  plotRange = NULL,
  plotN = 10,
  plotGrid = c("es", "qs"),
  alpha = 0.05,
  type = NULL,
  lty = NULL,
  lwd = NULL,
  lcol = NULL,
  pty = NULL,
  pwd = NULL,
  pcol = NULL,
  CItype = NULL,
  CIuniform = FALSE,
  CIsimul = 2000,
  CIshade = NULL,
  CIcol = NULL,
  bwselect = NULL,
  hist = TRUE,
  histBreaks = NULL,
  histFillCol = 3,
  histFillShade = 0.2,
  histLineCol = "white",
  title = "",
  xlabel = "",
  ylabel = "",
  legendTitle = NULL,
  legendGroups = NULL,
  noPlot = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>rdd</code></td>
<td>
<p>Object returned by <code>rddensity</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>X</code></td>
<td>
<p>Numeric vector or one dimensional matrix/data frame, the running variable.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>plotRange</code></td>
<td>
<p>Numeric, specifies the lower and upper bound of the plotting region.  Default is
<code>[c-3*hl,c+3*hr]</code> (three bandwidths around the cutoff).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>plotN</code></td>
<td>
<p>Numeric, specifies the number of grid points used for plotting on the two sides of the cutoff.
Default is <code>c(10,10)</code> (i.e., 10 points are used on each side).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>plotGrid</code></td>
<td>
<p>String, specifies how the grid points are positioned.  Options are <code>es</code> (evenly spaced)
and <code>qs</code> (quantile spaced).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>
<p>Numeric scalar between 0 and 1, the significance level for plotting
confidence regions. If more than one is provided, they will be applied to the two sides
accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>type</code></td>
<td>
<p>String, one of <code>"line"</code> (default), <code>"points"</code> or <code>"both"</code>, how
the point estimates are plotted. If more than one is provided, they will be applied to the two sides
accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lty</code></td>
<td>
<p>Line type for point estimates, only effective if <code>type</code> is <code>"line"</code> or
<code>"both"</code>. <code>1</code> for solid line, <code>2</code> for dashed line, <code>3</code> for dotted line.
For other options, see the instructions for <code>ggplot2</code> or <code>par</code>. If
more than one is provided, they will be applied to the two sides accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lwd</code></td>
<td>
<p>Line width for point estimates, only effective if <code>type</code> is <code>"line"</code> or
<code>"both"</code>. Should be strictly positive. For other options, see the instructions for
<code>ggplot2</code> or <code>par</code>. If more than one is provided, they will be applied
to the two sides accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lcol</code></td>
<td>
<p>Line color for point estimates, only effective if <code>type</code> is <code>"line"</code> or
<code>"both"</code>. <code>1</code> for black, <code>2</code> for red, <code>3</code> for green, <code>4</code> for blue.
For other options, see the instructions for <code>ggplot2</code> or <code>par</code>. If
more than one is provided, they will be applied to the two sides
accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pty</code></td>
<td>
<p>Scatter plot type for point estimates, only effective if <code>type</code> is <code>"points"</code> or
<code>"both"</code>. For options, see the instructions for <code>ggplot2</code> or <code>par</code>. If
more than one is provided, they will be applied to the two sides
accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pwd</code></td>
<td>
<p>Scatter plot size for point estimates, only effective if <code>type</code> is <code>"points"</code> or
<code>"both"</code>. Should be strictly positive. If more than one is provided, they will be applied to the two sides
accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pcol</code></td>
<td>
<p>Scatter plot color for point estimates, only effective if <code>type</code> is <code>"points"</code> or
<code>"both"</code>. <code>1</code> for black, <code>2</code> for red, <code>3</code>
for green, <code>4</code> for blue.
For other options, see the instructions for <code>ggplot2</code> or <code>par</code>. If
more than one is provided, they will be applied to the two sides
accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CItype</code></td>
<td>
<p>String, one of <code>"region"</code> (shaded region, default), <code>"line"</code> (dashed lines),
<code>"ebar"</code> (error bars), <code>"all"</code> (all of the previous) or <code>"none"</code> (no confidence region),
how the confidence region should be plotted. If more than one is provided, they will be applied to the two sides
accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CIuniform</code></td>
<td>
<p><code>TRUE</code> or <code>FALSE</code> (default), plotting either pointwise confidence intervals (<code>FALSE</code>) or
uniform confidence bands (<code>TRUE</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CIsimul</code></td>
<td>
<p>Positive integer, the number of simulations used to construct critical values (default is 2000). This
option is ignored if <code>CIuniform=FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CIshade</code></td>
<td>
<p>Numeric, opaqueness of the confidence region, should be between 0 (transparent) and
1. Default is 0.2. If more than one is provided, they will be applied to the two sides
accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CIcol</code></td>
<td>
<p>Color of the confidence region. <code>1</code> for black, <code>2</code> for red, <code>3</code>
for green, <code>4</code> for blue.
For other options, see the instructions for <code>ggplot2</code> or <code>par</code>. If
more than one is provided, they will be applied to the two sides
accordingly.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bwselect</code></td>
<td>
<p>String, the method for data-driven bandwidth selection. Available options
are (1) <code>"mse-dpi"</code> (mean squared error-optimal bandwidth selected for each grid point);
(2) <code>"imse-dpi"</code> (integrated MSE-optimal bandwidth, common for all grid points);
(3) <code>"mse-rot"</code> (rule-of-thumb bandwidth with Gaussian reference model);
and (4) <code>"imse-rot"</code> (integrated rule-of-thumb bandwidth with Gaussian reference model).
If omitted, bandwidths returned by <code>rddensity</code> will be used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>hist</code></td>
<td>
<p><code>TRUE</code> (default) or <code>FALSE</code>, whether adding a histogram to the background.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>histBreaks</code></td>
<td>
<p>Numeric vector, giving the breakpoints between histogram cells.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>histFillCol</code></td>
<td>
<p>Color of the histogram cells.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>histFillShade</code></td>
<td>
<p>Opaqueness of the histogram cells, should be between 0 (transparent) and
1. Default is 0.2.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>histLineCol</code></td>
<td>
<p>Color of the histogram lines.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>title, xlabel, ylabel</code></td>
<td>
<p>Strings, title of the plot and labels for x- and y-axis.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>legendTitle</code></td>
<td>
<p>String, title of legend.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>legendGroups</code></td>
<td>
<p>String Vector, group names used in legend.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>noPlot</code></td>
<td>
<p>No density plot will be generated if set to <code>TRUE</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Bias correction is only used for the construction of confidence intervals/bands, but not for point
estimation. The point estimates, denoted by <code>f_p</code>, are constructed using local polynomial estimates of order
<code>p</code>, while the centering of the confidence intervals/bands, denoted by <code>f_q</code>, are constructed using local
polynomial estimates of order <code>q</code>. The confidence intervals/bands take the form:
<code>[f_q - cv * SE(f_q) , f_q + cv * SE(f_q)]</code>, where <code>cv</code> denotes the appropriate critical value and
<code>SE(f_q)</code> denotes a standard error estimate
for the centering of the confidence interval/band. As a result, the confidence intervals/bands may not be
centered at the point estimates because they have been bias-corrected. Setting <code>q</code> and <code>p</code> to be equal
results on centered at the point estimate confidence intervals/bands, but requires undersmoothing for valid
inference (i.e., (I)MSE-optimal bandwdith for the density point estimator cannot be used).  Hence the bandwidth
would need to be specified manually when <code>q=p</code>, and the point estimates will not be (I)MSE optimal. See
Cattaneo, Jansson and Ma (2022, 2023) for details, and also Calonico, Cattaneo, and Farrell (2018, 2022) for
robust bias correction methods.
</p>
<p>Sometimes the density point estimates may lie outside of the confidence intervals/bands, which can happen if
the underlying distribution exhibits high curvature at some evaluation point(s).  One possible solution in this
case is to increase the polynomial order <code>p</code> or to employ a smaller bandwidth.
</p>


<h3>Value</h3>

<table>
<tr style="vertical-align: top;">
<td><code>Estl, Estr</code></td>
<td>
<p>Matrices containing estimation results:
(1) <code>grid</code> (grid points),
(2) <code>bw</code> (bandwidths),
(3) <code>nh</code> (number of observations in each local neighborhood),
(4) <code>nhu</code> (number of unique observations in each local neighborhood),
(5) <code>f_p</code> (point estimates with p-th order local polynomial),
(6) <code>f_q</code> (point estimates with q-th order local polynomial, only if option <code>q</code> is nonzero),
(7) <code>se_p</code> (standard error corresponding to <code>f_p</code>), and (8) <code>se_q</code> (standard error
corresponding to <code>f_q</code>).
Variance-covariance matrix corresponding to <code>f_p</code>.
Variance-covariance matrix corresponding to <code>f_q</code>.
A list containing options passed to the function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Estplot</code></td>
<td>
<p>A stadnard <code>ggplot</code> object is returned, hence can be used for further customization.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Matias D. Cattaneo, Princeton University  <a href="mailto:cattaneo@princeton.edu">cattaneo@princeton.edu</a>.
</p>
<p>Michael Jansson, University of California Berkeley.  <a href="mailto:mjansson@econ.berkeley.edu">mjansson@econ.berkeley.edu</a>.
</p>
<p>Xinwei Ma (maintainer), University of California San Diego. <a href="mailto:x1ma@ucsd.edu">x1ma@ucsd.edu</a>.
</p>


<h3>References</h3>

<p>Calonico, S., M. D. Cattaneo, and M. H. Farrell. 2018. On the Effect of Bias Estimation on Coverage Accuracy in Nonparametric Inference. <em>Journal of the American Statistical Association</em> 113(522): 767-779. <a href="https://doi.org/10.1080/01621459.2017.1285776">doi:10.1080/01621459.2017.1285776</a>
</p>
<p>Calonico, S., M. D. Cattaneo, and M. H. Farrell. 2022. Coverage Error Optimal Confidence Intervals for Local Polynomial Regression. <em>Bernoulli</em>, 28(4): 2998-3022. <a href="https://doi.org/10.3150/21-BEJ1445">doi:10.3150/21-BEJ1445</a>
</p>
<p>Cattaneo, M. D., M. Jansson, and X. Ma. 2018. Manipulation Testing based on Density Discontinuity. <em>Stata Journal</em> 18(1): 234-261. <a href="https://doi.org/10.1177/1536867X1801800115">doi:10.1177/1536867X1801800115</a>
</p>
<p>Cattaneo, M. D., M. Jansson, and X. Ma. 2020. Simple Local Polynomial Density Estimators. <em>Journal of the American Statistical Association</em>, 115(531): 1449-1455. <a href="https://doi.org/10.1080/01621459.2019.1635480">doi:10.1080/01621459.2019.1635480</a>
</p>
<p>Cattaneo, M. D., M. Jansson, and X. Ma. 2022. lpdensity: Local Polynomial Density Estimation and Inference. <em>Journal of Statistical Software</em>, 101(2): 1–25. <a href="https://doi.org/10.18637/jss.v101.i02">doi:10.18637/jss.v101.i02</a>
</p>
<p>Cattaneo, M. D., M. Jansson, and X. Ma. 2023. Local Regression Distribution Estimators. <em>Journal of Econometrics</em>, 240(2): 105074. <a href="https://doi.org/10.1016/j.jeconom.2021.01.006">doi:10.1016/j.jeconom.2021.01.006</a>
</p>


<h3>See Also</h3>

<p><code>rddensity</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R"># Generate a random sample with a density discontinuity at 0
set.seed(42)
x &lt;- rnorm(2000, mean = -0.5)
x[x &gt; 0] &lt;- x[x &gt; 0] * 2

# Estimation
rdd &lt;- rddensity(X = x)
summary(rdd)

# Density plot (from -2 to 2 with 25 evaluation points at each side)
plot1 &lt;- rdplotdensity(rdd, x, plotRange = c(-2, 2), plotN = 25)

# Plotting a uniform confidence band
set.seed(42) # fix the seed for simulating critical values
plot3 &lt;- rdplotdensity(rdd, x, plotRange = c(-2, 2), plotN = 25, CIuniform = TRUE)

</code></pre>


</div>