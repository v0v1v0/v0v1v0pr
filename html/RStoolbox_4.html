<div class="container">

<table style="width: 100%;"><tr>
<td>cloudShadowMask</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Cloud Shadow Masking for Flat Terrain</h2>

<h3>Description</h3>

<p>Intended for interactive use, <code>cloudShadowMask</code> will ask the user to select a few 
corresponding cloud/cloudShadow pixels which will be used to estimate coordinates 
for a linear cloudmask shift.
</p>


<h3>Usage</h3>

<pre><code class="language-R">cloudShadowMask(
  img,
  cm,
  nc = 5,
  shiftEstimate = NULL,
  preciseShift = NULL,
  quantile = 0.2,
  returnShift = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>img</code></td>
<td>
<p>SpatRaster containing the scene</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cm</code></td>
<td>
<p>SpatRaster. Cloud mask (typically the result of <code>cloudMask</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nc</code></td>
<td>
<p>Integer. Number of control points. A few points (default) are fine because the final shift is estimated by coregisterImages.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>shiftEstimate</code></td>
<td>
<p>NULL or numeric vector of length two (x,y). Estimated displacement of shadows in map units. If <code>NULL</code>, the user will be asked to select control points interactively.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>preciseShift</code></td>
<td>
<p>NULL or numeric vector of length two (x,y). Use this if cloud/cloud-shadow displacement is already known, e.g. from a previous run of <code>cloudShadowMask</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quantile</code></td>
<td>
<p>Numeric (between 0 and 1). Quantile threshold used for image co-registration. By default the 20% quantile of the total intensity (sum) of the image is used as potential shadow mask.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>returnShift</code></td>
<td>
<p>Logical. Return a numeric vector containing the shift parameters. Useful if you estimate parameters on a subset of the image.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This is a very simplistic approach to cloud shadow masking (simple shift of the cloud mask). It is not image based and accuracy will suffer from clouds at different altitudes. However, just as cloudMask
this is a quick and easy to use tool for Landsat data if you're just working on a few scenes and don't have fMask or CDR data at hand. Although for some test scenes
it does perform surprisingly well.
</p>


<h3>Value</h3>

<p>Returns a RasterLayer with the cloud shadow mask (0 = shadow, NA = not-shadow).
</p>


<h3>See Also</h3>

<p>cloudMask
</p>


<h3>Examples</h3>

<pre><code class="language-R">library(ggplot2)
## Import Landsat example subset
## We have two tiny clouds in the east
ggRGB(lsat, stretch = "lin")

## Calculate cloud index
cldmsk    &lt;- cloudMask(lsat, blue = 1, tir = 6)
ggR(cldmsk, 2, geom_raster = TRUE) 

## Define threshold (re-use the previously calculated index)
## Everything above the threshold is masked
## In addition we apply a region-growing around the core cloud pixels
cldmsk_final &lt;- cloudMask(cldmsk, threshold = 0.1, buffer = 5) 

## Plot cloudmask 
ggRGB(lsat, stretch = "lin") +
   ggR(cldmsk_final[[1]], ggLayer = TRUE, forceCat = TRUE, geom_raster = TRUE) +
   scale_fill_manual(values = c("red"), na.value = NA)

#' ## Estimate cloud shadow displacement
## Interactively (click on cloud pixels and the corresponding shadow pixels)
## Not run:  shadow &lt;- cloudShadowMask(lsat, cldmsk_final, nc = 2) 

## Non-interactively. Pre-defined shadow displacement estimate (shiftEstimate)
shadow &lt;- cloudShadowMask(lsat, cldmsk_final, shiftEstimate = c(-16,-6))

## Plot
csmask &lt;- terra::merge(cldmsk_final[[1]], shadow)
ggRGB(lsat, stretch = "lin") +
        ggR(csmask, ggLayer = TRUE, forceCat = TRUE, geom_raster = TRUE) +
        scale_fill_manual(values = c("blue", "yellow"), 
        labels = c("shadow", "cloud"), na.value = NA)

</code></pre>


</div>