<div class="container">

<table style="width: 100%;"><tr>
<td>pifMatch</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Pseudo-Invariant Features based Image Matching</h2>

<h3>Description</h3>

<p>Match one scene to another based on linear regression of pseudo-invariant features (PIF).
</p>


<h3>Usage</h3>

<pre><code class="language-R">pifMatch(
  img,
  ref,
  method = "cor",
  quantile = 0.95,
  returnPifMap = TRUE,
  returnSimMap = TRUE,
  returnModels = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>img</code></td>
<td>
<p>SpatRaster. Image to be adjusted.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ref</code></td>
<td>
<p>SpatRaster. Reference image.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>Method to calculate pixel similarity. Options: euclidean distance ('ed'), spectral angle ('sam') or pearson correlation coefficient ('cor').</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quantile</code></td>
<td>
<p>Numeric. Threshold quantile used to identify PIFs</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>returnPifMap</code></td>
<td>
<p>Logical. Return a binary raster map ot pixels which were identified as pesudo-invariant features.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>returnSimMap</code></td>
<td>
<p>Logical. Return the similarity map as well</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>returnModels</code></td>
<td>
<p>Logical. Return the linear models along with the adjusted image.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The function consists of three main steps:
First, it calculates pixel-wise similarity between the two rasters and identifies pseudo-invariant pixels based on 
a similarity threshold. 
In the second step the values of the pseudo-invariant pixels are regressed against each other in a linear model for each layer.
Finally the linear models are applied to all pixels in the <code>img</code>, thereby matching it to the reference scene.
</p>
<p>Pixel-wise similarity can be calculated using one of three methods: euclidean distance (<code>method = "ed"</code>), spectral angle (<code>"sam"</code>) or pearsons correlation coefficient (<code>"cor"</code>).
The threshold is defined as a similarity quantile. Setting <code>quantile=0.95</code> will select all pixels with a similarity above the 95% quantile as pseudo-invariant features.
</p>
<p>Model fitting is performed with simple linear models (<code>lm</code>); fitting one model per layer.
</p>


<h3>Value</h3>

<p>Returns a List with the adjusted image and intermediate products (if requested). 
</p>

<ul>
<li> <p><code>img</code>: the adjusted image
</p>
</li>
<li> <p><code>simMap</code>: pixel-wise similarity map (if <code>returnSimMap = TRUE</code>)
</p>
</li>
<li> <p><code>pifMap</code>: binary map of pixels selected as pseudo-invariant features (if <code>returnPifMap = TRUE</code>) 
</p>
</li>
<li> <p><code>models</code>: list of linear models; one per layer (if <code>returnModels = TRUE</code>)                          
</p>
</li>
</ul>
<h3>Examples</h3>

<pre><code class="language-R">library(terra)


## Create fake example data
## In practice this would be an image from another acquisition date
lsat_b &lt;- log(lsat)

## Run pifMatch and return similarity layer, invariant features mask and models
lsat_b_adj &lt;- pifMatch(lsat_b, lsat, returnPifMap = TRUE,
                         returnSimMap = TRUE, returnModels = TRUE)

## Pixelwise similarity
ggR(lsat_b_adj$simMap, geom_raster = TRUE)

## Pesudo invariant feature mask 
ggR(lsat_b_adj$pifMap)

## Histograms of changes
par(mfrow=c(1,3))
hist(lsat_b[[1]], main = "lsat_b")
hist(lsat[[1]], main = "reference")
hist(lsat_b_adj$img[[1]], main = "lsat_b adjusted")

## Model summary for first band
summary(lsat_b_adj$models[[1]])

</code></pre>


</div>