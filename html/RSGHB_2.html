<div class="container">

<table style="width: 100%;"><tr>
<td>doHB</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Estimate a Hierarchical Bayesian Model
</h2>

<h3>Description</h3>

<p>The user can initiate the model estimation by calling the <code>doHB</code> function. The function will optionally perform initial diagnostic tests to look for common errors in specifying the model. Upon completion, the function will optionally write a number of output files with the model parameters and convergence statistics to the user's working directory. 
</p>
<p>The flexibility comes in allowing the user to specify the likelihood function directly instead of assuming predetermined model structures. Types of models that can be estimated with this code include the family of discrete choice models (Multinomial Logit, Mixed Logit, Nested Logit, Error Components Logit and Latent Class) as well as ordered response models like ordered probit and ordered logit. In addition, the package allows for flexibility in specifying parameters as either fixed (non-varying across individuals) or random with continuous distributions. Parameter distributions supported include normal, positive/negative log-normal, positive/negative censored normal and the Johnson SB distribution.  
</p>
<p>Kenneth Train's Matlab and Gauss code for doing Hierarchical Bayesian estimation has served as the basis for a few of the functions included in this package. (See references below).
</p>


<h3>Usage</h3>

<pre><code class="language-R">doHB(likelihood_user, choicedata, control = list())
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>likelihood_user</code></td>
<td>
<p>A function that returns likelihood values for each observation in your data set. This function must accept arguments <code>fc</code> and <code>b</code>, representing the fixed parameters and individual parameters, respectively, and computes the likelihood of observing the data given those values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>choicedata</code></td>
<td>
<p>A data.frame of choice data to be used in estimation. Minimally requires an 'ID' column associated with the vector of likelihoods returned by <code>likelihood_user</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control</code></td>
<td>
<p>A list of estimation controls. See below for more details.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The <code>fc</code> argument to the <code>likelihood_user</code> function is a numeric vector of length <code>length(gVarNamesFixed)</code>. It is <code>NULL</code> if <code>gVarNamesFixed</code> is <code>NULL</code>.
</p>
<p>The <code>b</code> argument to the <code>likelihood_user</code> function is a numeric matrix with <code>length(gVarNamesNormal)</code> columns and <code>length(likelihood_user(...))</code> rows. In other words, one column per random parameter and one row per choice task. It is <code>NULL</code> if <code>gVarNamesNormal</code> is <code>NULL</code>.
</p>
<p>There are a number of global variables that can be set to control the model estimation. Some need to be specified directly in the model control list while others have default values that can be adjusted by the analyst if something other than the default is desired.
</p>
<p><b>User-specified controls</b>
</p>
<p><em>constraintsNorm</em> - A list of monotonic constraints to be applied during estimation. The structure of the constraints is <code>c(param1number, inequality, param2number)</code>. For constraints relative to <code>0</code>, use <code>0</code> instead of <code>param2number</code>. For <code>inequality</code>, use <code>1</code> for <code>&lt;</code> and <code>2</code> for <code>&gt;</code>.
</p>
<p>For example <code>constraintsNorm = list(c(5,1,0), c(6,1,5), c(7,1,6))</code> would constrain the 5th parameter &lt; 0, the 6th parameter &lt; 5th parameter, and the 7th parameter &lt; the 6th parameter. If <code>NULL</code>, no constraints are used. (Defaults to <code>NULL</code>)
</p>
<p><em>degreesOfFreedom</em> - Additional degrees of freedom for the prior variance-covariance matrix, not including the number of parameters. (Defaults to <code>5</code>) 
</p>
<p><em>FC</em> - A vector of starting values for the fixed parameters. There should be an element for each name in <em>gVarNamesFixed</em>. (Defaults to <code>rep(0, length(gVarNamesFixed))</code>)
</p>
<p><em>fixedA</em> - Fixes the means of the underlying normal distribution of random variables to certain values as opposed to estimating them. This would be important for example in an error components logit model or an integrated choice and latent variable model. The format for this input is a vector of length equal to the number of random parameters. Use <code>NA</code> for variables that should be estimated, e.g., <code>fixedA = c(NA, NA, NA, NA, NA, NA, NA, 0)</code>. In this case, the mean of the underlying normal for the 8th random variable would be fixed to <code>0</code>. If <code>NULL</code>, all means are estimated. (Defaults to <code>NULL</code>)
</p>
<p><em>fixedD</em> - Fixes the variance of the underlying normal distribution of the random variables to certain values as opposed to estimating them. This would be important for example in an integrated choice and latent variable model. The format for this input is a vector of length equal to the number of random parameters. Use <code>NA</code> for variables that should be estimated, e.g., <code>fixedD = c(NA, NA, NA, NA, NA, NA, NA, 1)</code>. In this case, the variance of the underlying normal for the 8th random variable would be fixed to <code>1</code>. If <code>NULL</code>, all variances are estimated. (Defaults to <code>NULL</code>)
</p>
<p><em>gDIST</em> - A vector of integers (1-6) that indicate which type of distribution should be applied to the random parameters. 1 = Normal, 2 = Postive Log-Normal, 3 = Negative Log-Normal, 4 = Positive Censored Normal, 5 = Negative Censored Normal, 6 = Johnson SB. There should be an element for each name in <code>gVarNamesNormal</code>. (Defaults to <code>rep(1, length(gVarNamesNormal))</code>)
</p>
<p><em>gFULLCV</em> - Indicates whether a full variance-covariance structure should be used for the random parameters. (Defaults to <code>TRUE</code>)
</p>
<p><em>gINFOSKIP</em> - Number of iterations between printing/plotting information about the iteration process. (Defaults to <code>250</code>)
</p>
<p><em>gMAXCOEF</em> - A vector of maximums for the Johnson SB distributions. If Johnson SB is used, each random coefficent needs an element but only the elements that correspond to a JSB in <code>gDIST</code> are used. (Defaults to <code>0</code>)
</p>
<p><em>gMINCOEF</em> - A vector of minimums for the Johnson SB distributions. If Johnson SB is used, each random coefficent needs an element but only the elements that correspond to a JSB in <code>gDIST</code> are used. (Defaults to <code>0</code>)
</p>
<p><em>gNCREP</em> - Number of burn-in iterations to use prior to convergence. (Defaults to <code>100000</code>)
</p>
<p><em>gNEREP</em> - Number of iterations to keep for averaging after convergence has been reached. (Defaults to <code>100000</code>)
</p>
<p><em>gNSKIP</em> - Number of iterations in between retaining draws for averaging. (Defaults to <code>1</code>)
</p>
<p><em>gVarNamesFixed</em> - A character vector of names for the fixed parameters. (REQUIRED)
</p>
<p><em>gVarNamesNormal</em> - A character vector of names for the random parameters. (REQUIRED)
</p>
<p><em>gStoreDraws</em> - Whether to store the draws for the individual level parameters. Doing so can dramatically increase the memory usage of the model if there are a large number of individuals or draws. (Defaults to <code>FALSE</code>)
</p>
<p><em>hIW</em> - A boolean indicating if a hierarchical Inverted Wishart should be used when sampling in posterior distribution for the covariance matrix. New in version 1.2.0. (Defaults to <code>FALSE</code>)
</p>
<p><em>modelname</em> - The model name which is used for creating output files. (Defaults to <code>"HBModel"</code>)
</p>
<p><em>nodiagnostics</em> - If <code>TRUE</code>, an initial diagnostic report and prompt is not reported to the screen. This makes batch processing more seamless. (Defaults to <code>FALSE</code>)
</p>
<p><em>priorVariance</em> - The prior variance assumed. Ignored if <code>pvMatrix</code> is not <code>NULL</code>. (Defaults to <code>2</code>)
</p>
<p><em>pvMatrix</em> - A custom prior variance-covariance matrix to be used in estimation. The prior variance-covariance matrix needs to be a matrix object and of the correct size: <code>length(gVarNamesNormal)</code> by <code>length(gVarNamesNormal)</code>. If provided, overrides <code>priorVariance</code>. (Defaults to <code>NULL</code>)
</p>
<p><em>rho</em> - The initial proportionality fraction for the jumping distribution of the Metropolis-Hastings algorithm for the random parameters. This fraction is adjusted after each iteration to target an acceptance rate of <code>targetAcceptanceNormal</code>. (Defaults to <code>0.1</code>)       
</p>
<p><em>rhoF</em> - The proportionality fraction for the jumping distribution for the Metropolis-Hastings algorithm for the fixed parameters. This fraction is adjusted after each iteration to target an acceptance rate of <code>targetAcceptanceFixed</code>. (Defaults to <code>0.0001</code>)
</p>
<p><em>svN</em> - A vector of starting values for the means of the underlying normals for the random parameters. There should be an element for each name in <code>gVarNamesNormal</code>. (Defaults to <code>rep(0, length(gVarNamesNormal))</code>)
</p>
<p><em>targetAcceptanceFixed</em> - The target acceptance rate in the Metropolis-Hastings algorithm for the fixed parameters. (Defaults to <code>0.3</code>)
</p>
<p><em>targetAcceptanceNormal</em> - The target acceptance rate in the Metropolis-Hastings algorithm for the random parameters. (Defaults to <code>0.3</code>)
</p>
<p><em>verbose</em> - Whether estimation information should be printed/plotted during the iteration process. (Defaults to <code>TRUE</code>)
</p>
<p><em>writeModel</em> - Indicates whether the model results should be written as a series of CSV files to the working directory upon estimation completion. (Defaults to <code>FALSE</code>, see <code>writeModel</code>)
</p>


<h3>Value</h3>

<p>a model object of class <code>RSGHB</code>. Contains:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>modelname</code></td>
<td>
<p>A character string identifying the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>params.fixed</code></td>
<td>
<p>A character vector naming the estimated fixed parameters.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>params.vary</code></td>
<td>
<p>A character vector naming the estimated random parameters.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>distributions</code></td>
<td>
<p>A character vector of assumed distributions for each random parameter.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pv</code></td>
<td>
<p>The prior variance-covariance matrix assumed for estimation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>df</code></td>
<td>
<p>Additional degrees of freedom in the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gNP</code></td>
<td>
<p>The number of individuals in the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gOBS</code></td>
<td>
<p>The number of observations in the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gNCREP</code></td>
<td>
<p>The number of burn-in iterations used prior to convergence.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gNEREP</code></td>
<td>
<p>The number of iterations used for averaging.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>constraints</code></td>
<td>
<p>A list of constraints. (see 'Details' above)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>iter.detail</code></td>
<td>
<p>A data.frame of model statistics at every <code>gINFOSKIP</code>'th iteration.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>A</code></td>
<td>
<p>A matrix containing the sample-level means of the underlying normals at each iteration. Is <code>NULL</code> if no random parameters were estimated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>B, Bsd</code></td>
<td>
<p>A matrix containing the mean individual-level draws across iterations for the underlying normals. The <code>Bsd</code> object provides the standard deviations of these individual draws. Is <code>NULL</code> if no random parameters were estimated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>C, Csd</code></td>
<td>
<p>A matrix containing the mean individual-level draws across iterations for the underlying normals while including the appropriate distribution transformations. The <code>Csd</code> object provides the standard deviations of these individual draws. Is <code>NULL</code> if no random parameters were estimated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>D</code></td>
<td>
<p>An array of the sample variance-covariance matrix for each iteration. Is <code>NULL</code> if no random parameters were estimated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>F</code></td>
<td>
<p>A matrix containing the set of fixed (non-random) parameters at each iteration. Is <code>NULL</code> if no fixed parameters were estimated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>choices</code></td>
<td>
<p>A vector of choices if provided.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p</code></td>
<td>
<p>A vector of probabilities at the mean values of <code>C</code> and <code>F</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ll0</code></td>
<td>
<p>The initial log-likelihood given the starting values of <code>sVN</code> and <code>FC</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>llf</code></td>
<td>
<p>The final log-likelihood at the mean values of <code>C</code> and <code>F</code>.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Jeffrey Dumont &lt;jeff.dumont@rsginc.com&gt;, Jeff Keller &lt;jeff.keller@rsginc.com&gt;
</p>


<h3>References</h3>

<p>Train, K. (2009) Discrete Choice Methods with Simulation. Cambridge University Press.
</p>
<p>Train, K. and Sonnier G. (2005) <em>Mixed Logit with Bounded Distributions of Correlated Partworths</em>, Applications of Simulation Methods in Environmental and Resource Economics. Edited by Anna Alberini and Riccardo Scarpa. http://elsa.berkeley.edu/~train/trainsonnier.pdf
</p>
<p>Train, K. Original Gauss and Matlab code: http://elsa.berkeley.edu/Software/abstracts/train1006mxlhb.html 
</p>


<h3>See Also</h3>

<p><code>plot.RSGHB, writeModel</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R"># Organize choicedata for modeling
data(choicedata)
tt1 &lt;- choicedata$tt1
tt2 &lt;- choicedata$tt2
toll2 &lt;- choicedata$toll2
choice1 &lt;- (choicedata$Choice==1)
choice2 &lt;- (choicedata$Choice==2)

# The model likelihood function
likelihood &lt;- function(fc, b) {  
     
     # Assign Beta vectors to named parameters for convenience
     cc    &lt;- 1
     wtp1  &lt;- b[, cc]; cc &lt;- cc + 1
     price &lt;- b[, cc]; cc &lt;- cc + 1
     
     # Discrete choice utility in WTP-space
     v1 &lt;-                 price * wtp1 * tt1
     v2 &lt;- price * toll2 + price * wtp1 * tt2
     
     # Return the probability of choice
     p  &lt;- (exp(v1)*choice1 + exp(v2)*choice2) / (exp(v1) + exp(v2))
     return(p)
}

# Estimation controls/settings
control &lt;- list(
     modelname = "MNL_WTPSpace",
     gVarNamesNormal = c("WTP", "Price"),
     gNCREP = 300,
     gNEREP = 100,
     gINFOSKIP = 10,
     gNSKIP = 2,
     nodiagnostics = TRUE
)

# Estimate the model
set.seed(1987)
     
          model &lt;- doHB(likelihood, choicedata, control)
     
</code></pre>


</div>