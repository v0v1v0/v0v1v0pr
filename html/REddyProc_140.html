<div class="container">

<table style="width: 100%;"><tr>
<td>usEstUstarThreshold</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>usEstUstarThreshold - Estimating ustar threshold</h2>

<h3>Description</h3>

<p>Estimate the Ustar threshold by aggregating the estimates for
seasonal and temperature subsets.</p>


<h3>Usage</h3>

<pre><code class="language-R">usEstUstarThreshold(ds, seasonFactor = usCreateSeasonFactorMonth(ds$sDateTime), 
    yearOfSeasonFactor = usGetYearOfSeason(seasonFactor, 
        ds$sDateTime), ctrlUstarEst = usControlUstarEst(), 
    ctrlUstarSub = usControlUstarSubsetting(), 
    fEstimateUStarBinned = usEstUstarThresholdSingleFw2Binned, 
    isCleaned = FALSE, isInBootstrap = FALSE)</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>ds</code></td>
<td>
<p>data.frame with columns "sDateTime", "Ustar", "NEE", "Tair", and "Rg"</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seasonFactor</code></td>
<td>
<p>factor for subsetting times (see details)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>yearOfSeasonFactor</code></td>
<td>
<p>named integer vector: for each seasonFactor level, get the year
(aggregation period) that this season belongs to</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ctrlUstarEst</code></td>
<td>
<p>control parameters for estimating uStar on a single binned series,
see <code>usControlUstarEst</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ctrlUstarSub</code></td>
<td>
<p>control parameters for
subsetting time series (number of temperature and Ustar classes ...),
see <code>usControlUstarSubsetting</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fEstimateUStarBinned</code></td>
<td>
<p>function to
estimate UStar on a single binned series,
see <code>usEstUstarThresholdSingleFw2Binned</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>isCleaned</code></td>
<td>
<p>set to TRUE, if the data was cleaned already,
to avoid expensive call to <code>usGetValidUstarIndices</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>isInBootstrap</code></td>
<td>
<p>set to TRUE if this is called from
<code>sEddyProc_sEstimateUstarScenarios</code> to avoid further
bootstraps in change-point detection</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The threshold for sufficiently turbulent conditions u * (Ustar)
is estimated for different subsets of the time series.
From the estimates for each season (each value in <code>seasonFactor</code>)
the maximum of all seasons of one year is reported as estimate for this year.
Within each season the time series is split by temperature classes.
Among these Ustar estimates, the median is reported as season value.
</p>
<p>In order to split the seasons, the uses must provide a vector with argument
<code>seasonFactor</code>.
All positions with the same factor, belong to
the same season. It is conveniently generated by one of the following functions:
</p>

<ul>
<li> <p><code>usCreateSeasonFactorMonth</code>
(default DJF-MAM-JJA-SON with December from previous to January of the year) 
</p>
</li>
<li> <p><code>usCreateSeasonFactorMonthWithinYear</code>
(default DJF-MAM-JJA-SON with December from the same year) 
</p>
</li>
<li> <p><code>usCreateSeasonFactorYday</code>
for a refined specification of season starts. 
</p>
</li>
<li> <p><code>usCreateSeasonFactorYdayYear</code>
for specifying different seasons season between years. 
</p>
</li>
</ul>
<p>The estimation of Ustar on a single binned series can be selected argument
<code>fEstimateUStarBinned</code>.
</p>

<ul>
<li> <p><code>usEstUstarThresholdSingleFw1Binned</code> 
</p>
</li>
<li> <p><code>usEstUstarThresholdSingleFw2Binned</code> (default) 
</p>
</li>
</ul>
<p>This function is called by
</p>

<ul>
<li> <p><code>sEddyProc_sEstUstarThold</code> which stores the result
in the class variables (sUSTAR and sDATA).
</p>
</li>
<li> <p><code>sEddyProc_sEstUstarThresholdDistribution</code> which
additionally estimates median and confidence intervals for each year
by bootstrapping the original data within seasons.
</p>
</li>
</ul>
<p>For inspecting the NEE~uStar relationship plotting is provided by
<code>sEddyProc_sPlotNEEVersusUStarForSeason</code>
</p>
<dl>
<dt>change point detection (CPT) method</dt>
<dd>
<p>With specifying
<code>ctrlUstarEst = usControlUstarEst(isUsingCPTSeveralT = TRUE)</code>
change point detection is applied instead of the moving point test
(e.g. with Fw2Binned).
</p>
<p>The sometimes sensitive binning of uStar values within a temperature
class is avoided.
Further, possible spurious thresholds are avoid by testing that the
model with a threshold
fits the data better than a model without a threshold using a
likelihood ratio test.
In addition, with CPT seasons are excluded where a threshold
was detected in only less
than ctrlUstarEst$minValidUStarTempClassesProp (default 20%) of the
temperature classes.
</p>
<p>Note, that this method often gives higher estimates of the u * threshold.
</p>
</dd>
</dl>
<dl>
<dt>One-big-season fallback</dt>
<dd>
<p>If there are too few records within one year, of when no season yielded a
finite u * Threshold estimate, then
the yearly u * Th is estimated by pooling the data from seasons within one
seasonYear.
The user can suppress using pooled data on few records by providing option
<code>ctrlUstarSub$isUsingOneBigSeasonOnFewRecords = FALSE</code>
(see <code>usControlUstarSubsetting</code>)
</p>
</dd>
</dl>
<h3>Value</h3>

<p>A list with entries
data.frame with columns "aggregationMode", "seasonYear", "season", "uStar"
with rows for "single": the entire aggregate (median across years)
, "seasonYear": each year (maximum across seasons or estimate on pooled data)
, "season": each season (median across temperature classes)
</p>
<table>
<tr style="vertical-align: top;">
<td><code>seasonYear</code></td>
<td>
<p>data.frame
listing results for year with columns "seasonYear"
, "uStarMaxSeason" the maximum across seasonal estimates within the year
, "uStarPooled" the estimate based on data pooled across the year
(only calculated on few valid records or on uStarMaxSeason was nonfinite)
, "nRec" number of valid records  (only if the pooled estimate was calculated)
, "uStarAggr" chosen estimate, corresponding to uStarPooled
if this was calculated,
or uStarMaxSeason or uStarTh across years if the former was non-finite</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>season</code></td>
<td>
<p>data.frame listing results for each season
, "nRec" the number of valid records
, "uStarSeasonEst" the estimate for based on data within the season
(median across temperature classes)
, "uStarAggr" chose estimate, corresponding to uStarSeasonEst,
or the yearly seasonYear$uStarAggr, if the former was non-finite</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tempInSeason</code></td>
<td>
<p>numeric matrix
(nTemp x nAggSeason):
estimates for each temperature subset for each season</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bins</code></td>
<td>
<p>columns
<code>season</code>, <code>tempBin</code> and <code>uStarBin</code>
for each record of input <code>ds</code>
reporting classes of similar environmental conditions
that the record belongs to.
</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>TW, OM
Department for Biogeochemical Integration at MPI-BGC, Jena, Germany &lt;REddyProc-help@bgc-jena.mpg.de&gt; [cph], Thomas Wutzler &lt;twutz@bgc-jena.mpg.de&gt; [aut, cre], Markus Reichstein &lt;mreichstein@bgc-jena.mpg.de&gt; [aut], Antje Maria Moffat &lt;antje.moffat@bgc.mpg.de&gt; [aut, trl], Olaf Menzer &lt;omenzer@bgc-jena.mpg.de&gt; [ctb], Mirco Migliavacca &lt;mmiglia@bgc-jena.mpg.de&gt; [aut], Kerstin Sickel &lt;ksickel@bgc-jena.mpg.de&gt; [ctb, trl], Ladislav &lt;U+0160&gt;igut &lt;sigut.l@czechglobe.cz&gt; [ctb]</p>


<h3>References</h3>

<p>Ustar filtering following the idea in Papale, D. et al. (2006)
Towards a standardized processing of net ecosystem exchange measured with
eddy covariance technique: algorithms and uncertainty estimation.
Biogeosciences 3(4): 571-583.</p>


</div>